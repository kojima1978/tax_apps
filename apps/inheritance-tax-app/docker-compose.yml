# ============================================
# 相続税シミュレーター - Docker Compose
# ============================================
# Usage:
#   開発:   docker compose up -d
#   再ビルド: docker compose up -d --build
#   ログ:   docker compose logs -f
#   停止:   docker compose down
# ============================================

# 共通設定
x-common-env: &common-env
  TZ: Asia/Tokyo

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 60s

services:
  # ===========================================
  # 相続税シミュレーター（Vite dev server）
  # Port: 3004
  #
  # 機能:
  #   - 早見表（法定相続人パターン別の税額一覧）
  #   - 相続税計算（按分税額・配偶者控除・2割加算）
  #   - 1次2次相続比較（配偶者取得割合別の税額比較）
  #   - 保険金シミュレーション（非課税枠活用の節税効果）
  #   - 現金贈与シミュレーション（生前贈与の節税効果）
  #   - Excel出力・印刷対応
  # ===========================================
  inheritance-tax-app:
    build:
      context: .
      dockerfile: Dockerfile
      target: dev
    container_name: inheritance-tax-app-standalone
    ports:
      - "3004:3004"
    volumes:
      # ソースコードをマウント（ホットリロード用）
      - ./src:/app/src:ro
      - ./public:/app/public:ro
    environment:
      <<: *common-env
      NODE_ENV: development
    init: true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "node -e \"(async()=>{try{const r=await fetch('http://127.0.0.1:3004/inheritance-tax-app/');process.exit(r.ok?0:1)}catch{process.exit(1)}})()\""]
      <<: *healthcheck-defaults
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
