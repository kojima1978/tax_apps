# ============================================
# 確定申告 必要書類案内 - Docker Compose
# ============================================
# Usage:
#   開発:   docker compose up -d
#   再ビルド: docker compose up -d --build
#   ログ:   docker compose logs -f
#   停止:   docker compose down
#   本番:   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================

# 共通設定
x-common-env: &common-env
  TZ: Asia/Tokyo

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 30s

# セキュリティオプション（権限昇格防止）
x-security-opts: &security-opts
  security_opt:
    - no-new-privileges:true

services:
  # ===========================================
  # バックエンドAPI（Express + SQLite）
  # Port: 3006
  #
  # 機能:
  #   - 必要書類データのCRUD API
  #   - SQLiteによるデータ永続化
  # ===========================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: dev
    <<: *security-opts
    container_name: tax-docs-backend
    networks:
      - tax-apps-network
    ports:
      - "3006:3006"
    volumes:
      # ソースコードをマウント（ホットリロード用）
      - ./backend/src:/app/src:ro
      # データ永続化
      - backend-data:/app/data
    environment:
      <<: *common-env
      NODE_ENV: development
      PORT: "3006"
    init: true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "node -e \"(async()=>{try{const r=await fetch('http://127.0.0.1:3006/api/health');process.exit(r.ok?0:1)}catch{process.exit(1)}})()\""]
      <<: *healthcheck-defaults
      start_period: 8s
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # フロントエンド（Vite + React）
  # Port: 3005
  #
  # 機能:
  #   - 確定申告に必要な書類のリスト管理
  #   - 申告区分ごとの書類表示
  # ===========================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: dev
    <<: *security-opts
    container_name: tax-docs-frontend
    networks:
      - tax-apps-network
    ports:
      - "3005:3005"
    volumes:
      - ./frontend/src:/app/src:ro
      - ./frontend/index.html:/app/index.html:ro
    environment:
      <<: *common-env
      NODE_ENV: development
      VITE_API_URL: http://localhost:3006
    command: npm run dev -- --host --port 3005
    depends_on:
      backend:
        condition: service_healthy
    init: true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3005/tax-docs/ || exit 1"]
      <<: *healthcheck-defaults
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

# ==========================================
# ネットワーク定義
# ==========================================
networks:
  tax-apps-network:
    external: true

# ==========================================
# ボリューム定義
# ==========================================
volumes:
  backend-data:
    name: tax-docs-data
