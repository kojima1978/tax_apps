{% extends 'analyzer/base.html' %}
{% load humanize %}
{% load japanese_date %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{% url 'case-list' %}"
                        class="text-decoration-none text-muted">æ¡ˆä»¶ä¸€è¦§</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ case.name }}</li>
            </ol>
        </nav>
        <h1 class="h2 mb-0">{{ case.name }}</h1>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'transaction-import' case.pk %}" class="btn btn-primary">
            ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        </a>
        <a href="{% url 'analysis-dashboard' pk=case.pk %}" class="btn btn-secondary">
            ğŸ“Š åˆ†æãƒ»ã‚°ãƒ©ãƒ•
        </a>
    </div>
</div>

<div class="glass-card p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h5">å–å¼•å±¥æ­´ ({{ total_count }}ä»¶)
            {% if transactions.paginator.num_pages > 1 %}
            <small class="text-muted">({{ transactions.number }} / {{ transactions.paginator.num_pages }}ãƒšãƒ¼ã‚¸)</small>
            {% endif %}
        </h3>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>æ—¥ä»˜</th>
                    <th>éŠ€è¡Œå</th>
                    <th>æ”¯åº—å</th>
                    <th>å£åº§ç•ªå·</th>
                    <th>æ‘˜è¦</th>
                    <th class="text-end">å‡ºé‡‘</th>
                    <th class="text-end">å…¥é‡‘</th>
                    <th class="text-end">æ®‹é«˜</th>
                    <th>åˆ†é¡</th>
                    <th>æ¨å®š</th>
                    <th>ä»˜ç®‹</th>
                    <th>ãƒ¡ãƒ¢</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr class="{% if tx.is_large %}table-danger{% endif %}">
                    <td>{{ tx.date|wareki_short }}</td>
                    <td>{{ tx.bank_name|default:"-" }}</td>
                    <td>{{ tx.branch_name|default:"-" }}</td>
                    <td>{{ tx.account_id|default:"-" }}</td>
                    <td>
                        {{ tx.description }}
                        {% if tx.is_transfer %}
                        <span class="badge bg-info text-dark ms-1">è³‡é‡‘ç§»å‹•</span>
                        {% endif %}
                    </td>
                    <td class="text-end text-danger">
                        {% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}
                    </td>
                    <td class="text-end text-success">
                        {% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}
                    </td>
                    <td class="text-end text-muted">
                        {{ tx.balance|intcomma }}
                    </td>
                    <td>
                        <span class="badge bg-secondary">{{ tx.category|default:"-" }}</span>
                    </td>
                    <td>
                        <small class="text-muted">{{ tx.transfer_to|default:"" }}</small>
                    </td>
                    <td class="text-center">
                        {% if tx.is_flagged %}
                        <span class="text-info" title="ä»˜ç®‹ã‚ã‚Š">ğŸ“Œ</span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">{{ tx.memo|default:""|truncatechars:20 }}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %} flag-btn"
                                data-tx-id="{{ tx.id }}" data-page="{{ transactions.number }}"
                                title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                ğŸ“Œ
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-info" title="è©³ç´°ãƒ»ç·¨é›†"
                                data-bs-toggle="modal" data-bs-target="#editModal"
                                data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}"
                                data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}"
                                data-tx-amount-in="{{ tx.amount_in }}" data-tx-cat="{{ tx.category|default:'' }}"
                                data-tx-memo="{{ tx.memo|default:'' }}"
                                data-tx-bank="{{ tx.bank_name|default:'' }}"
                                data-tx-branch="{{ tx.branch_name|default:'' }}"
                                data-tx-account="{{ tx.account_id|default:'' }}">
                                ğŸ“
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="13" class="text-center py-4 text-muted">
                        ã¾ã å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                        CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    {% if transactions.paginator.num_pages > 1 %}
    <nav aria-label="å–å¼•å±¥æ­´ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" class="mt-3">
        <ul class="pagination justify-content-center mb-0">
            {% if transactions.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1">&laquo; æœ€åˆ</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions.previous_page_number }}">å‰ã¸</a>
            </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">{{ transactions.number }} / {{ transactions.paginator.num_pages }}</span>
            </li>

            {% if transactions.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions.next_page_number }}">æ¬¡ã¸</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions.paginator.num_pages }}">æœ€å¾Œ &raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title">å–å¼•ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_transaction">
                <input type="hidden" name="tx_id" id="modalTxId">
                <input type="hidden" name="page" value="{{ transactions.number }}">

                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <label class="form-label">éŠ€è¡Œå</label>
                            <select name="bank_name" class="form-select form-select-sm" id="modalTxBankName">
                                <option value="">-- é¸æŠ --</option>
                                {% for bank in banks %}
                                <option value="{{ bank }}">{{ bank }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label">æ”¯åº—å</label>
                            <select name="branch_name" class="form-select form-select-sm" id="modalTxBranchName">
                                <option value="">-- é¸æŠ --</option>
                                {% for branch in branches %}
                                <option value="{{ branch }}">{{ branch }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-4">
                            <label class="form-label">å£åº§ç•ªå·</label>
                            <select name="account_id" class="form-select form-select-sm" id="modalTxAccountId">
                                <option value="">-- é¸æŠ --</option>
                                {% for acc in accounts %}
                                <option value="{{ acc }}">{{ acc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ—¥ä»˜</label>
                        <input type="date" name="date" id="modalTxDate" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ‘˜è¦</label>
                        <input type="text" name="description" id="modalTxDescInput" class="form-control">
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <label class="form-label">æ‰•æˆ»ï¼ˆå‡ºé‡‘ï¼‰</label>
                            <input type="number" name="amount_out" id="modalTxAmountOut" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="form-label">ãŠé ã‚Šï¼ˆå…¥é‡‘ï¼‰</label>
                            <input type="number" name="amount_in" id="modalTxAmountIn" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†é¡</label>
                        <select name="category" class="form-select" id="modalTxCat">
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ğŸ“ ãƒ¡ãƒ¢</label>
                        <textarea name="memo" id="modalTxMemo" class="form-control" rows="3"
                            placeholder="ç¢ºèªäº‹é …ãªã©ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã—ã‚‡ã†..."></textarea>
                    </div>

                    <div class="alert alert-warning py-2 small">
                        <i class="bi bi-info-circle"></i> æ—¥ä»˜ã‚„é‡‘é¡ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€æ®‹é«˜ã®æ•´åˆæ€§ãŒå–ã‚Œãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Edit Modal Logic
    const editModal = document.getElementById('editModal');
    if (editModal) {
        editModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const txId = button.getAttribute('data-tx-id');
            const txDate = button.getAttribute('data-tx-date');
            const txDesc = button.getAttribute('data-tx-desc');
            const txAmountOut = button.getAttribute('data-tx-amount-out');
            const txAmountIn = button.getAttribute('data-tx-amount-in');
            const txCat = button.getAttribute('data-tx-cat');
            const txMemo = button.getAttribute('data-tx-memo');
            const txBank = button.getAttribute('data-tx-bank');
            const txBranch = button.getAttribute('data-tx-branch');
            const txAccount = button.getAttribute('data-tx-account');

            document.getElementById('modalTxId').value = txId;
            document.getElementById('modalTxDate').value = txDate;
            document.getElementById('modalTxDescInput').value = txDesc;
            document.getElementById('modalTxAmountOut').value = txAmountOut;
            document.getElementById('modalTxAmountIn').value = txAmountIn;
            document.getElementById('modalTxCat').value = txCat || 'æœªåˆ†é¡';
            document.getElementById('modalTxMemo').value = txMemo || '';
            document.getElementById('modalTxBankName').value = txBank || '';
            document.getElementById('modalTxBranchName').value = txBranch || '';
            document.getElementById('modalTxAccountId').value = txAccount || '';
        });
    }

    // Flag toggle via JavaScript fetch (to avoid form nesting issues)
    document.querySelectorAll('.flag-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const txId = this.getAttribute('data-tx-id');
            const page = this.getAttribute('data-page');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            const formData = new FormData();
            formData.append('action', 'toggle_flag');
            formData.append('tx_id', txId);
            formData.append('page', page);
            formData.append('csrfmiddlewaretoken', csrfToken);

            fetch(window.location.pathname, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    window.location.href = window.location.pathname + '?page=' + page;
                }
            });
        });
    });
});
</script>
{% endblock %}
