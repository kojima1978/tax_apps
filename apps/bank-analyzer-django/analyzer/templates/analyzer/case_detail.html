{% extends 'analyzer/base.html' %}
{% load humanize %}
{% load japanese_date %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-1">
                <li class="breadcrumb-item"><a href="{% url 'case-list' %}"
                        class="text-decoration-none text-muted">æ¡ˆä»¶ä¸€è¦§</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ case.name }}</li>
            </ol>
        </nav>
        <h1 class="h2 mb-0">{{ case.name }}</h1>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'transaction-import' case.pk %}" class="btn btn-primary">
            ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        </a>
        <a href="{% url 'analysis-dashboard' pk=case.pk %}" class="btn btn-secondary">
            ğŸ“Š åˆ†æãƒ»ã‚°ãƒ©ãƒ•
        </a>
    </div>
</div>

<div class="glass-card p-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h5">å–å¼•å±¥æ­´ ({{ total_count }}ä»¶)
            {% if transactions.paginator.num_pages > 1 %}
            <small class="text-muted">({{ transactions.number }} / {{ transactions.paginator.num_pages }}ãƒšãƒ¼ã‚¸)</small>
            {% endif %}
        </h3>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead>
                <tr>
                    <th>æ—¥ä»˜</th>
                    <th>éŠ€è¡Œå</th>
                    <th>æ”¯åº—å</th>
                    <th>å£åº§ç•ªå·</th>
                    <th>æ‘˜è¦</th>
                    <th class="text-end">å‡ºé‡‘</th>
                    <th class="text-end">å…¥é‡‘</th>
                    <th class="text-end">æ®‹é«˜</th>
                    <th>åˆ†é¡</th>
                    <th>æ¨å®š</th>
                    <th>ä»˜ç®‹</th>
                    <th>ãƒ¡ãƒ¢</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in transactions %}
                <tr class="{% if tx.is_large %}table-danger{% endif %}">
                    <td>{{ tx.date|wareki_short }}</td>
                    <td>{{ tx.bank_name|default:"-" }}</td>
                    <td>{{ tx.branch_name|default:"-" }}</td>
                    <td>{{ tx.account_id|default:"-" }}</td>
                    <td>
                        {{ tx.description }}
                        {% if tx.is_transfer %}
                        <span class="badge bg-info text-dark ms-1">è³‡é‡‘ç§»å‹•</span>
                        {% endif %}
                    </td>
                    <td class="text-end text-danger">
                        {% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}
                    </td>
                    <td class="text-end text-success">
                        {% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}
                    </td>
                    <td class="text-end text-muted">
                        {{ tx.balance|intcomma }}
                    </td>
                    <td>
                        <span class="badge bg-secondary">{{ tx.category|default:"-" }}</span>
                    </td>
                    <td>
                        <small class="text-muted">{{ tx.transfer_to|default:"" }}</small>
                    </td>
                    <td class="text-center">
                        {% if tx.is_flagged %}
                        <span class="text-info" title="ä»˜ç®‹ã‚ã‚Š">ğŸ“Œ</span>
                        {% endif %}
                    </td>
                    <td>
                        <small class="text-muted">{{ tx.memo|default:""|truncatechars:20 }}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <form method="post" class="d-inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="toggle_flag">
                                <input type="hidden" name="tx_id" value="{{ tx.id }}">
                                <input type="hidden" name="page" value="{{ transactions.number }}">
                                <button type="submit" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %}" title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                    ğŸ“Œ
                                </button>
                            </form>
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="ãƒ¡ãƒ¢ã‚’ç·¨é›†"
                                data-bs-toggle="modal" data-bs-target="#memoModal"
                                data-tx-id="{{ tx.id }}" data-tx-memo="{{ tx.memo|default:'' }}">
                                ğŸ“
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="13" class="text-center py-4 text-muted">
                        ã¾ã å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>
                        CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    {% if transactions.paginator.num_pages > 1 %}
    <nav aria-label="å–å¼•å±¥æ­´ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" class="mt-3">
        <ul class="pagination justify-content-center mb-0">
            {% if transactions.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1">&laquo; æœ€åˆ</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions.previous_page_number }}">å‰ã¸</a>
            </li>
            {% endif %}

            <li class="page-item disabled">
                <span class="page-link">{{ transactions.number }} / {{ transactions.paginator.num_pages }}</span>
            </li>

            {% if transactions.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions.next_page_number }}">æ¬¡ã¸</a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ transactions.paginator.num_pages }}">æœ€å¾Œ &raquo;</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Memo Modal -->
<div class="modal fade" id="memoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title">ğŸ“ ãƒ¡ãƒ¢ã®ç·¨é›†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_memo">
                <input type="hidden" name="tx_id" id="memoModalTxId">
                <input type="hidden" name="page" value="{{ transactions.number }}">

                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ãƒ¡ãƒ¢</label>
                        <textarea name="memo" id="memoModalText" class="form-control" rows="4"
                            placeholder="ç¢ºèªäº‹é …ãªã©ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã—ã‚‡ã†..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Memo Modal Logic
document.addEventListener('DOMContentLoaded', function() {
    const memoModal = document.getElementById('memoModal');
    if (memoModal) {
        memoModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const txId = button.getAttribute('data-tx-id');
            const txMemo = button.getAttribute('data-tx-memo');

            document.getElementById('memoModalTxId').value = txId;
            document.getElementById('memoModalText').value = txMemo || '';
        });
    }
});
</script>
{% endblock %}
