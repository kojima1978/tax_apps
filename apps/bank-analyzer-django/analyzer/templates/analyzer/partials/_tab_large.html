{% load humanize %}
{% load japanese_date %}

<div class="tab-pane fade" id="large" role="tabpanel" aria-labelledby="large-tab">
    <div class="glass-card p-4">
        <!-- åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
        <form method="get" class="row g-3 mb-4">
            <input type="hidden" name="tab" value="large">
            <div class="col-md-4">
                <label class="form-label">åˆ†é¡ã§çµã‚Šè¾¼ã¿</label>
                <select name="large_category" class="form-select" multiple size="3">
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat in filter_state.large_category %}selected{% endif %}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">çµã‚Šè¾¼ã¿æ–¹æ³•</label>
                <div class="d-flex gap-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="large_category_mode" id="large_mode_include" value="include" {% if filter_state.large_category_mode != 'exclude' %}checked{% endif %}>
                        <label class="form-check-label" for="large_mode_include">é¸æŠã‚’å«ã‚€</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="large_category_mode" id="large_mode_exclude" value="exclude" {% if filter_state.large_category_mode == 'exclude' %}checked{% endif %}>
                        <label class="form-check-label" for="large_mode_exclude">é¸æŠä»¥å¤–</label>
                    </div>
                </div>
            </div>
            <div class="col-md-3 d-flex align-items-end gap-2">
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> çµã‚Šè¾¼ã¿
                </button>
                <a href="{% url 'analysis-dashboard' case.pk %}?tab=large" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                </a>
            </div>
        </form>

        <form method="post" id="largeTxForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="bulk_update_categories">
            <input type="hidden" name="source_tab" value="large">

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">å¤šé¡å–å¼•ãƒªã‚¹ãƒˆ {% if filter_state.large_category %}<small class="text-muted">(ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­)</small>{% endif %}</h4>
                <div>
                    {% if large_txs %}
                    <button type="submit" class="btn btn-primary btn-sm me-2">
                        <i class="bi bi-check-lg"></i> åˆ†é¡ã‚’ä¸€æ‹¬ä¿å­˜
                    </button>
                    <a href="{% url 'export-csv' case.pk 'large' %}" class="btn btn-outline-success btn-sm">
                        <i class="bi bi-download"></i> CSVå‡ºåŠ›
                    </a>
                    {% endif %}
                </div>
            </div>
            {% if large_txs %}
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>éŠ€è¡Œå</th>
                            <th>æ”¯åº—å</th>
                            <th>ç¨®åˆ¥</th>
                            <th>å£åº§ç•ªå·</th>
                            <th>æ‘˜è¦</th>
                            <th>æ‰•æˆ»</th>
                            <th>ãŠé ã‚Š</th>
                            <th style="min-width: 130px;">åˆ†é¡</th>
                            <th>æ“ä½œ</th>
                            <th>ğŸ“Œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in large_txs %}
                        <tr>
                            <td>{{ tx.date|wareki_short }}</td>
                            <td>{{ tx.bank_name|default:"-" }}</td>
                            <td>{{ tx.branch_name|default:"-" }}</td>
                            <td>{{ tx.account_type|default:"-" }}</td>
                            <td>{{ tx.account_id|default:"-" }}</td>
                            <td>{{ tx.description }}</td>
                            <td class="text-end text-danger fw-bold">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                            <td class="text-end text-success fw-bold">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                            <td>
                                <select name="cat-{{ tx.id }}" class="form-select form-select-sm">
                                    {% for cat in categories %}
                                    <option value="{{ cat }}" {% if tx.category == cat %}selected{% endif %}>{{ cat }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModal" data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}" data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}" data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}" data-tx-cat="{{ tx.category|default:'' }}" data-tx-memo="{{ tx.memo|default:'' }}" data-tx-bank="{{ tx.bank_name|default:'' }}" data-tx-branch="{{ tx.branch_name|default:'' }}" data-tx-account-type="{{ tx.account_type|default:'' }}" data-tx-account="{{ tx.account_id|default:'' }}">è©³ç´°</button>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %} flag-btn"
                                    data-tx-id="{{ tx.id }}" data-source-tab="large"
                                    title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                    ğŸ“Œ
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">è©²å½“ã™ã‚‹å¤šé¡å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§é–¾å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
            {% endif %}
        </form>
    </div>
</div>
