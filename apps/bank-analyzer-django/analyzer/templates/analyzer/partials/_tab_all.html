{% load humanize %}
{% load japanese_date %}

<div class="tab-pane fade" id="all" role="tabpanel" aria-labelledby="all-tab">
    <div class="glass-card p-4">
        <!-- Filters -->
        <form method="get" class="row g-3 mb-4">
            <input type="hidden" name="tab" value="all">
            <div class="col-md-2">
                <label class="form-label">æ—¥ä»˜ç¯„å›²</label>
                <div class="d-flex align-items-center gap-1 mb-1">
                    <span class="small text-muted" style="width: 45px;">é–‹å§‹æ—¥</span>
                    <input type="date" name="date_from" class="form-control form-control-sm" value="{{ filter_state.date_from|default:'' }}">
                </div>
                <div class="d-flex align-items-center gap-1">
                    <span class="small text-muted" style="width: 45px;">çµ‚äº†æ—¥</span>
                    <input type="date" name="date_to" class="form-control form-control-sm" value="{{ filter_state.date_to|default:'' }}">
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">éŠ€è¡Œå</label>
                <select name="bank" class="form-select" multiple size="3">
                    {% for bank in banks %}
                    <option value="{{ bank }}" {% if bank in filter_state.bank %}selected{% endif %}>{{ bank }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">å£åº§</label>
                <select name="account" class="form-select" multiple size="3">
                    {% for acc in accounts %}
                    <option value="{{ acc }}" {% if acc in filter_state.account %}selected{% endif %}>{{ acc }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">åˆ†é¡</label>
                <select name="category" class="form-select" multiple size="3">
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if cat in filter_state.category %}selected{% endif %}>{{ cat }}
                    </option>
                    {% endfor %}
                </select>
                <div class="d-flex gap-2 mt-1">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="category_mode" id="cat_mode_include" value="include" {% if filter_state.category_mode != 'exclude' %}checked{% endif %}>
                        <label class="form-check-label small" for="cat_mode_include">å«ã‚€</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="category_mode" id="cat_mode_exclude" value="exclude" {% if filter_state.category_mode == 'exclude' %}checked{% endif %}>
                        <label class="form-check-label small" for="cat_mode_exclude">ä»¥å¤–</label>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                <input type="text" name="keyword" class="form-control" value="{{ filter_state.keyword }}"
                    placeholder="æ‘˜è¦ã‚’æ¤œç´¢..." style="height: 72px;">
            </div>
            <div class="col-md-2 d-flex align-items-start gap-1 pt-4">
                <button class="btn btn-sm btn-outline-secondary" type="submit">
                    <i class="bi bi-search"></i> çµã‚Šè¾¼ã¿
                </button>
                <a href="{% url 'analysis-dashboard' case.pk %}?tab=all" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                </a>
            </div>
        </form>

        <!-- é‡‘é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¼ï¼‰ -->
        <div class="mb-4">
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#amountFilterCollapse" aria-expanded="{% if filter_state.amount_min or filter_state.amount_max or filter_state.amount_type != 'both' or filter_state.large_only %}true{% else %}false{% endif %}">
                <i class="bi bi-funnel"></i> é‡‘é¡ã§çµã‚Šè¾¼ã¿
                {% if filter_state.amount_min or filter_state.amount_max or filter_state.amount_type != 'both' or filter_state.large_only %}
                <span class="badge bg-primary ms-1">é©ç”¨ä¸­</span>
                {% endif %}
            </button>
            <a href="{% url 'analysis-dashboard' case.pk %}?tab=all" class="btn btn-sm btn-outline-secondary ms-2">
                <i class="bi bi-x-lg"></i> ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢
            </a>
            <div class="collapse {% if filter_state.amount_min or filter_state.amount_max or filter_state.amount_type != 'both' or filter_state.large_only %}show{% endif %}" id="amountFilterCollapse">
                <form method="get" class="row g-3 mt-2 p-3 bg-light rounded">
                    <!-- ã‚¿ãƒ–çŠ¶æ…‹ã‚’ä¿æŒ -->
                    <input type="hidden" name="tab" value="all">
                    <!-- æ—¢å­˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ä¿æŒ -->
                    {% for b in filter_state.bank %}<input type="hidden" name="bank" value="{{ b }}">{% endfor %}
                    {% for a in filter_state.account %}<input type="hidden" name="account" value="{{ a }}">{% endfor %}
                    {% for c in filter_state.category %}<input type="hidden" name="category" value="{{ c }}">{% endfor %}
                    {% if filter_state.category_mode %}<input type="hidden" name="category_mode" value="{{ filter_state.category_mode }}">{% endif %}
                    {% if filter_state.keyword %}<input type="hidden" name="keyword" value="{{ filter_state.keyword }}">{% endif %}
                    {% if filter_state.date_from %}<input type="hidden" name="date_from" value="{{ filter_state.date_from }}">{% endif %}
                    {% if filter_state.date_to %}<input type="hidden" name="date_to" value="{{ filter_state.date_to }}">{% endif %}

                    <div class="col-md-2">
                        <label class="form-label small">å–å¼•ç¨®åˆ¥</label>
                        <select name="amount_type" class="form-select form-select-sm">
                            <option value="both" {% if filter_state.amount_type == 'both' %}selected{% endif %}>å‡ºé‡‘ãƒ»å…¥é‡‘ä¸¡æ–¹</option>
                            <option value="out" {% if filter_state.amount_type == 'out' %}selected{% endif %}>å‡ºé‡‘ã®ã¿</option>
                            <option value="in" {% if filter_state.amount_type == 'in' %}selected{% endif %}>å…¥é‡‘ã®ã¿</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">æœ€å°é‡‘é¡</label>
                        <input type="text" name="amount_min" class="form-control form-control-sm"
                            value="{{ filter_state.amount_min }}" placeholder="ä¾‹: 100000">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">æœ€å¤§é‡‘é¡</label>
                        <input type="text" name="amount_max" class="form-control form-control-sm"
                            value="{{ filter_state.amount_max }}" placeholder="ä¾‹: 500000">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="large_only" value="1" id="largeOnlyCheck"
                                {% if filter_state.large_only %}checked{% endif %}>
                            <label class="form-check-label small" for="largeOnlyCheck">å¤šé¡å–å¼•ã®ã¿</label>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary btn-sm w-100" type="submit">
                            <i class="bi bi-filter"></i> é‡‘é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- åˆ†é¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form method="post" id="allTxForm">
            {% csrf_token %}
            <input type="hidden" name="action" value="bulk_update_categories">
            <input type="hidden" name="source_tab" value="all">
            <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ä¿æŒ -->
            {% for bank in filter_state.bank %}
            <input type="hidden" name="filter_bank" value="{{ bank }}">
            {% endfor %}
            {% for acc in filter_state.account %}
            <input type="hidden" name="filter_account" value="{{ acc }}">
            {% endfor %}
            {% for cat in filter_state.category %}
            <input type="hidden" name="filter_category" value="{{ cat }}">
            {% endfor %}
            {% if filter_state.keyword %}
            <input type="hidden" name="filter_keyword" value="{{ filter_state.keyword }}">
            {% endif %}
            {% if all_txs.number %}
            <input type="hidden" name="filter_page" value="{{ all_txs.number }}">
            {% endif %}

            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">æ¤œç´¢çµæœ: {{ all_txs_count }}ä»¶
                    {% if all_txs.paginator.num_pages > 1 %}
                    <small class="text-muted">({{ all_txs.number }} / {{ all_txs.paginator.num_pages }}ãƒšãƒ¼ã‚¸)</small>
                    {% endif %}
                </h5>
                <div>
                    {% if all_txs %}
                    <button type="submit" class="btn btn-primary btn-sm me-2">
                        <i class="bi bi-check-lg"></i> åˆ†é¡ã‚’ä¸€æ‹¬ä¿å­˜
                    </button>
                    {% endif %}
                    <!-- çµã‚Šè¾¼ã¿çµæœã‚’CSVå‡ºåŠ› -->
                    <a href="{% url 'export-csv-filtered' case.pk %}?{% for b in filter_state.bank %}bank={{ b }}&{% endfor %}{% for a in filter_state.account %}account={{ a }}&{% endfor %}{% for c in filter_state.category %}category={{ c }}&{% endfor %}{% if filter_state.category_mode %}category_mode={{ filter_state.category_mode }}&{% endif %}{% if filter_state.keyword %}keyword={{ filter_state.keyword }}&{% endif %}{% if filter_state.amount_min %}amount_min={{ filter_state.amount_min }}&{% endif %}{% if filter_state.amount_max %}amount_max={{ filter_state.amount_max }}&{% endif %}{% if filter_state.amount_type %}amount_type={{ filter_state.amount_type }}&{% endif %}{% if filter_state.large_only %}large_only={{ filter_state.large_only }}{% endif %}"
                       class="btn btn-success btn-sm me-1" title="ç¾åœ¨ã®çµã‚Šè¾¼ã¿çµæœã‚’CSVå‡ºåŠ›ï¼ˆ{{ all_txs_count }}ä»¶ï¼‰">
                        <i class="bi bi-download"></i> çµè¾¼çµæœCSV
                    </a>
                    <a href="{% url 'export-csv' case.pk 'all' %}" class="btn btn-outline-success btn-sm me-1" title="å…¨ãƒ‡ãƒ¼ã‚¿ã‚’CSVå‡ºåŠ›">
                        <i class="bi bi-download"></i> å…¨ãƒ‡ãƒ¼ã‚¿CSV
                    </a>
                    <a href="{% url 'export-json' case.pk %}" class="btn btn-outline-primary btn-sm" title="JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                        <i class="bi bi-box-arrow-down"></i> JSON
                    </a>
                </div>
            </div>

            <!-- é¸æŠä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
            <div class="card bg-light mb-3" id="bulkActionBar" style="display: none;">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center gap-3">
                        <span id="selectedCountText" class="text-muted">0ä»¶é¸æŠä¸­</span>
                        <select id="bulkCategorySelect" class="form-select form-select-sm" style="width: 150px;">
                            <option value="">-- åˆ†é¡ã‚’é¸æŠ --</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-success btn-sm" id="applyBulkCategoryBtn">
                            <i class="bi bi-check-lg"></i> é¸æŠã‚’ä¸€æ‹¬å¤‰æ›´
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSelectionBtn">
                            <i class="bi bi-x-lg"></i> é¸æŠè§£é™¤
                        </button>
                    </div>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover align-middle table-sm">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" class="form-check-input" id="selectAllTx" title="å…¨é¸æŠ">
                            </th>
                            <th style="width: 60px;">+/-</th>
                            <th>æ—¥ä»˜</th>
                            <th>éŠ€è¡Œå</th>
                            <th>æ”¯åº—å</th>
                            <th>ç¨®åˆ¥</th>
                            <th>å£åº§ç•ªå·</th>
                            <th>æ‘˜è¦</th>
                            <th>æ‰•æˆ»</th>
                            <th>ãŠé ã‚Š</th>
                            <th style="min-width: 130px;">åˆ†é¡</th>
                            <th>æ“ä½œ</th>
                            <th>ğŸ“Œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in all_txs %}
                        <tr data-tx-id="{{ tx.id }}">
                            <td>
                                <input type="checkbox" value="{{ tx.id }}" class="form-check-input tx-select-check">
                            </td>
                            <td class="text-nowrap">
                                <button type="button" class="btn btn-sm btn-outline-success p-0 px-1 insert-tx-btn"
                                    data-tx-id="{{ tx.id }}"
                                    data-tx-date="{{ tx.date|date:'Y-m-d' }}"
                                    data-tx-bank="{{ tx.bank_name|default:'' }}"
                                    data-tx-branch="{{ tx.branch_name|default:'' }}"
                                    data-tx-account-type="{{ tx.account_type|default:'' }}"
                                    data-tx-account="{{ tx.account_id|default:'' }}"
                                    title="ã“ã®ä¸‹ã«è¿½åŠ ">
                                    <i class="bi bi-plus"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger p-0 px-1 delete-tx-btn"
                                    data-tx-id="{{ tx.id }}" title="å‰Šé™¤">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                            <td>{{ tx.date|wareki_short }}</td>
                            <td>{{ tx.bank_name|default:"-" }}</td>
                            <td>{{ tx.branch_name|default:"-" }}</td>
                            <td>{{ tx.account_type|default:"-" }}</td>
                            <td>{{ tx.account_id|default:"-" }}</td>
                            <td style="max-width: 200px;" class="text-truncate" title="{{ tx.description }}">{{ tx.description }}</td>
                            <td class="text-end">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                            <td class="text-end">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                            <td>
                                <select name="cat-{{ tx.id }}" class="form-select form-select-sm">
                                    {% for cat in categories %}
                                    <option value="{{ cat }}" {% if tx.category == cat %}selected{% endif %}>{{ cat }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModal" data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}" data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}" data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}" data-tx-cat="{{ tx.category|default:'' }}" data-tx-memo="{{ tx.memo|default:'' }}" data-tx-bank="{{ tx.bank_name|default:'' }}" data-tx-branch="{{ tx.branch_name|default:'' }}" data-tx-account-type="{{ tx.account_type|default:'' }}" data-tx-account="{{ tx.account_id|default:'' }}">è©³ç´°</button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %} flag-btn"
                                    data-tx-id="{{ tx.id }}" data-source-tab="all"
                                    title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                    ğŸ“Œ
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="13" class="text-center">å–å¼•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </form>

            <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
            {% if all_txs.paginator.num_pages > 1 %}
            <nav aria-label="å–å¼•ä¸€è¦§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" class="mt-3">
                <ul class="pagination justify-content-center mb-0">
                    {% if all_txs.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?tab=all&page=1{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                            &laquo; æœ€åˆ
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?tab=all&page={{ all_txs.previous_page_number }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                            å‰ã¸
                        </a>
                    </li>
                    {% endif %}

                    <li class="page-item disabled">
                        <span class="page-link">{{ all_txs.number }} / {{ all_txs.paginator.num_pages }}</span>
                    </li>

                    {% if all_txs.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?tab=all&page={{ all_txs.next_page_number }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                            æ¬¡ã¸
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?tab=all&page={{ all_txs.paginator.num_pages }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                            æœ€å¾Œ &raquo;
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}

        </form>
    </div>
</div>
