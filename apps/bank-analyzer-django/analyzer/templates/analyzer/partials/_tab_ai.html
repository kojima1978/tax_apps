<!-- AIåˆ†é¡ã‚¿ãƒ– -->
<div class="tab-pane fade" id="ai" role="tabpanel" aria-labelledby="ai-tab">
    <!-- è‡ªå‹•åˆ†é¡å®Ÿè¡Œé€šçŸ¥ -->
    {% if unclassified_count %}
    <div class="alert alert-warning d-flex align-items-center justify-content-between mb-4" role="alert">
        <div>
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>{{ unclassified_count }}ä»¶</strong>ã®æœªåˆ†é¡å–å¼•ãŒã‚ã‚Šã¾ã™ã€‚
            æ–°ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç™»éŒ²ã—ãŸå ´åˆã¯ã€è‡ªå‹•åˆ†é¡ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
        </div>
        <a href="{% url 'classify-preview' case.pk %}" class="btn btn-warning">
            <i class="bi bi-eye me-1"></i> ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦åˆ†é¡
        </a>
    </div>
    {% endif %}

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">ğŸ¤– AIåˆ†é¡ææ¡ˆ</h5>
        </div>
        <div class="card-body">
            {% if ai_suggestions %}
                <!-- ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒƒãƒãƒ³ã‚°é–¾å€¤èª¿æ•´ -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <label for="fuzzyThresholdSlider" class="form-label">
                            ãƒ•ã‚¡ã‚¸ãƒ¼ãƒãƒƒãƒãƒ³ã‚°é–¾å€¤: <strong id="fuzzyThresholdValue">{{ fuzzy_threshold }}%</strong>
                        </label>
                        <input type="range" class="form-range" id="fuzzyThresholdSlider"
                            min="70" max="100" step="5" value="{{ fuzzy_threshold }}"
                            onchange="AISuggestions.updateFuzzyThreshold(this.value)">
                        <small class="text-muted">
                            é«˜ã„é–¾å€¤ï¼ˆ95%ä»¥ä¸Šï¼‰: é«˜ç²¾åº¦ã ãŒå€™è£œãŒå°‘ãªã„<br>
                            ä½ã„é–¾å€¤ï¼ˆ70-80%ï¼‰: å€™è£œãŒå¤šã„ãŒç²¾åº¦ãŒä¸‹ãŒã‚‹
                        </small>
                    </div>
                    <div class="col-md-6 text-end">
                        <button type="button" class="btn btn-outline-primary" onclick="AISuggestions.regenerate()">
                            <i class="bi bi-arrow-clockwise"></i> ææ¡ˆã‚’å†ç”Ÿæˆ
                        </button>
                    </div>
                </div>

                <!-- ä¸€æ‹¬é©ç”¨ãƒœã‚¿ãƒ³ -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-success" onclick="AISuggestions.bulkApply(95)">
                                <i class="bi bi-check-all"></i> é«˜ä¿¡é ¼åº¦ã‚’ä¸€æ‹¬é©ç”¨ (95%ä»¥ä¸Š)
                            </button>
                            <button type="button" class="btn btn-warning" onclick="AISuggestions.bulkApply(85)">
                                <i class="bi bi-check-circle"></i> å…¨ã¦ä¸€æ‹¬é©ç”¨ (85%ä»¥ä¸Š)
                            </button>
                        </div>
                        <small class="text-muted ms-3">
                            å¯¾è±¡: {{ ai_suggestions|length }}ä»¶ã®æœªåˆ†é¡å–å¼•
                        </small>
                    </div>
                </div>

                <!-- AIææ¡ˆãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 5%;">ID</th>
                                <th style="width: 8%;">å–å¼•æ—¥</th>
                                <th style="width: 25%;">æ‘˜è¦</th>
                                <th style="width: 10%;" class="text-end">å‡ºé‡‘</th>
                                <th style="width: 10%;" class="text-end">å…¥é‡‘</th>
                                <th style="width: 14%;">AIææ¡ˆ</th>
                                <th style="width: 10%;" class="text-center">ä¿¡é ¼åº¦</th>
                                <th style="width: 18%;" class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for suggestion in ai_suggestions %}
                                <tr id="ai-row-{{ suggestion.tx_id }}">
                                    <td><small class="text-muted">#{{ suggestion.tx_id }}</small></td>
                                    <td>{{ suggestion.date|date:"Y/m/d" }}</td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px;" title="{{ suggestion.description }}">
                                            {{ suggestion.description }}
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        {% if suggestion.amount_out > 0 %}
                                            <span class="text-danger">Â¥{{ suggestion.amount_out|floatformat:0 }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if suggestion.amount_in > 0 %}
                                            <span class="text-success">Â¥{{ suggestion.amount_in|floatformat:0 }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-info text-dark">{{ suggestion.suggested_category }}</span>
                                        {% if suggestion.alternative_suggestions %}
                                            <button type="button" class="btn btn-sm btn-link p-0"
                                                data-bs-toggle="popover"
                                                data-bs-trigger="hover"
                                                data-bs-placement="top"
                                                data-bs-html="true"
                                                title="ãã®ä»–ã®å€™è£œ"
                                                data-bs-content="{% for alt in suggestion.alternative_suggestions %}<span class='badge bg-secondary'>{{ alt.category }} ({{ alt.score }}%)</span><br>{% endfor %}">
                                                <i class="bi bi-info-circle"></i>
                                            </button>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if suggestion.score >= 95 %}
                                            <span class="badge bg-success">{{ suggestion.score }}%</span>
                                        {% elif suggestion.score >= 85 %}
                                            <span class="badge bg-primary">{{ suggestion.score }}%</span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">{{ suggestion.score }}%</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-success"
                                                onclick="AISuggestions.apply({{ suggestion.tx_id }}, '{{ suggestion.suggested_category }}')">
                                                <i class="bi bi-check"></i> é©ç”¨
                                            </button>
                                            <button type="button" class="btn btn-success dropdown-toggle dropdown-toggle-split"
                                                data-bs-toggle="dropdown" aria-expanded="false">
                                                <span class="visually-hidden">ãã®ä»–</span>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <a class="dropdown-item" href="#"
                                                        onclick="AISuggestions.applyAndAddPattern({{ suggestion.tx_id }}, '{{ suggestion.suggested_category }}', '{{ suggestion.description|escapejs }}', 'global'); return false;">
                                                        <i class="bi bi-globe"></i> é©ç”¨ï¼‹ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¿½åŠ 
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item" href="#"
                                                        onclick="AISuggestions.applyAndAddPattern({{ suggestion.tx_id }}, '{{ suggestion.suggested_category }}', '{{ suggestion.description|escapejs }}', 'case'); return false;">
                                                        <i class="bi bi-folder"></i> é©ç”¨ï¼‹ã“ã®æ¡ˆä»¶ã«è¿½åŠ 
                                                    </a>
                                                </li>
                                            </ul>
                                            <button type="button" class="btn btn-outline-secondary"
                                                onclick="AISuggestions.dismiss({{ suggestion.tx_id }})">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ100ä»¶ä»¥ä¸Šã®å ´åˆï¼‰ -->
                {% if ai_suggestions|length >= 100 %}
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-info-circle"></i>
                        è¡¨ç¤ºã¯æœ€æ–°100ä»¶ã¾ã§ã§ã™ã€‚æ®‹ã‚Šã®æœªåˆ†é¡å–å¼•ã¯ä¸€æ‹¬é©ç”¨æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚
                    </div>
                {% endif %}

            {% else %}
                <!-- ææ¡ˆãªã— -->
                <div class="alert alert-success">
                    <h5 class="alert-heading">
                        <i class="bi bi-check-circle"></i> ã™ã¹ã¦ã®å–å¼•ãŒåˆ†é¡ã•ã‚Œã¦ã„ã¾ã™
                    </h5>
                    <p class="mb-0">
                        AIåˆ†é¡ãŒå¿…è¦ãªæœªåˆ†é¡ã®å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                        æ–°ã—ã„å–å¼•ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«ã“ã®ã‚¿ãƒ–ã«ææ¡ˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                    </p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="mt-4">
        {% include 'analyzer/partials/_pattern_manager.html' with show_global=True show_case=True global_patterns=global_patterns case_patterns=case_patterns case_id=case.id collapsed=True card_style="secondary" %}
    </div>
</div>
