{% extends 'analyzer/base.html' %}
{% load humanize %}
{% load japanese_date %}

{% block title %}Analysis - Bank Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h2">ğŸ“Š åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: {{ case.name }}</h1>
    </div>
    <div class="col-md-4 text-end">
        <form method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" name="action" value="run_classifier" class="btn btn-primary"
                onclick="return confirm('è‡ªå‹•åˆ†é¡ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®æ‰‹å‹•è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚')">
                <i class="bi bi-robot"></i> è‡ªå‹•åˆ†é¡å®Ÿè¡Œ
            </button>
        </form>
    </div>
</div>

<!-- Account Summary -->
<div class="glass-card p-4 mb-4">
    <h4 class="mb-3">ğŸ“‹ ç™»éŒ²å£åº§ä¸€è¦§</h4>
    <div class="row g-3">
        {% for acc in account_summary %}
        <div class="col-md-6 col-lg-4">
            <div class="card bg-white border-light shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-truncate" title="{{ acc.account_id }}">{{ acc.account_id }}</h5>
                    <p class="card-text text-muted mb-2">åç¾©: {{ acc.holder }}</p>
                    <div class="d-flex justify-content-between align-items-end">
                        <small>å–å¼•ä»¶æ•°: {{ acc.count }}ä»¶<br>æœ€çµ‚å–å¼•: {{ acc.last_date|wareki_short }}</small>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="account_id" value="{{ acc.account_id }}">
                            <button type="submit" name="action" value="delete_account"
                                class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('å£åº§ã€Œ{{ acc.account_id }}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦ã®å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')">
                                <i class="bi bi-trash"></i> å‰Šé™¤
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="transfers-tab" data-bs-toggle="tab" data-bs-target="#transfers"
            type="button" role="tab" aria-controls="transfers" aria-selected="true">
            ğŸ”„ è³‡é‡‘ç§»å‹•ãƒ•ãƒ­ãƒ¼
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="large-tab" data-bs-toggle="tab" data-bs-target="#large" type="button" role="tab"
            aria-controls="large" aria-selected="false">
            ğŸ’° å¤šé¡å‡ºé‡‘ãƒ»å…¥é‡‘
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab"
            aria-controls="all" aria-selected="false">
            ğŸ“„ å–å¼•ä¸€è¦§ãƒ»æ¤œç´¢
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link text-warning" id="cleanup-tab" data-bs-toggle="tab" data-bs-target="#cleanup"
            type="button" role="tab" aria-controls="cleanup" aria-selected="false">
            ğŸ§¹ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link text-info" id="flagged-tab" data-bs-toggle="tab" data-bs-target="#flagged"
            type="button" role="tab" aria-controls="flagged" aria-selected="false">
            ğŸ“Œ ä»˜ç®‹ {% if flagged_txs %}<span class="badge bg-info">{{ flagged_txs.count }}</span>{% endif %}
        </button>
    </li>
</ul>

<div class="tab-content" id="analysisTabsContent">
    <!-- Tab 1: Transfers -->
    <div class="tab-pane fade show active" id="transfers" role="tabpanel" aria-labelledby="transfers-tab">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0">è³‡é‡‘ç§»å‹•ã®å¯è¦–åŒ–</h4>
                {% if transfer_list %}
                <a href="{% url 'export-csv' case.pk 'transfers' %}" class="btn btn-outline-success btn-sm">
                    <i class="bi bi-download"></i> CSVå‡ºåŠ›
                </a>
                {% endif %}
            </div>
            {% if transfer_list %}
            <div id="transferChart" style="width:100%; height:500px;"></div>

            <h5 class="mt-4 mb-3">æ¤œå‡ºã•ã‚ŒãŸç§»å‹•ãƒªã‚¹ãƒˆ</h5>
            <div class="table-responsive">
                <table class="table table-sm table-hover text-nowrap">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>å‡ºé‡‘å…ƒ</th>
                            <th>ç§»å‹•å…ˆæ¨å®š</th>
                            <th>å‡ºé‡‘é¡</th>
                            <th>æ‘˜è¦</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in transfer_list %}
                        {% if row.amount_out > 0 %}
                        <tr>
                            <td>{{ row.date|wareki_short }}</td>
                            <td>{{ row.account_id }}</td>
                            <td>{{ row.transfer_to }}</td>
                            <td class="text-end">{{ row.amount_out|intcomma }}</td>
                            <td>{{ row.description }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">è³‡é‡‘ç§»å‹•ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</div>
            {% endif %}
        </div>
    </div>

    <!-- Tab 2: Large Transactions -->
    <div class="tab-pane fade" id="large" role="tabpanel" aria-labelledby="large-tab">
        <div class="glass-card p-4">
            <!-- åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <form method="get" class="row g-3 mb-4">
                <input type="hidden" name="tab" value="large">
                <div class="col-md-4">
                    <label class="form-label">åˆ†é¡ã§çµã‚Šè¾¼ã¿</label>
                    <select name="large_category" class="form-select" multiple size="3">
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat in filter_state.large_category %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i> çµã‚Šè¾¼ã¿
                    </button>
                    <a href="{% url 'analysis-dashboard' case.pk %}?tab=large" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                    </a>
                </div>
            </form>

            <form method="post" id="largeTxForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="bulk_update_categories">
                <input type="hidden" name="source_tab" value="large">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">å¤šé¡å–å¼•ãƒªã‚¹ãƒˆ {% if filter_state.large_category %}<small class="text-muted">(ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­)</small>{% endif %}</h4>
                    <div>
                        {% if large_txs %}
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="bi bi-check-lg"></i> åˆ†é¡ã‚’ä¸€æ‹¬ä¿å­˜
                        </button>
                        <a href="{% url 'export-csv' case.pk 'large' %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-download"></i> CSVå‡ºåŠ›
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% if large_txs %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œå</th>
                                <th>æ”¯åº—å</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>æ‘˜è¦</th>
                                <th>æ‰•æˆ»</th>
                                <th>ãŠé ã‚Š</th>
                                <th style="min-width: 130px;">åˆ†é¡</th>
                                <th>æ“ä½œ</th>
                                <th>ğŸ“Œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in large_txs %}
                            <tr>
                                <td>{{ tx.date|wareki_short }}</td>
                                <td>{{ tx.bank_name|default:"-" }}</td>
                                <td>{{ tx.branch_name|default:"-" }}</td>
                                <td>{{ tx.account_id|default:"-" }}</td>
                                <td>{{ tx.description }}</td>
                                <td class="text-end text-danger fw-bold">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                                <td class="text-end text-success fw-bold">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                                <td>
                                    <select name="cat-{{ tx.id }}" class="form-select form-select-sm">
                                        {% for cat in categories %}
                                        <option value="{{ cat }}" {% if tx.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModal" data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}" data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}" data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}" data-tx-cat="{{ tx.category|default:'' }}" data-tx-memo="{{ tx.memo|default:'' }}" data-tx-bank="{{ tx.bank_name|default:'' }}" data-tx-branch="{{ tx.branch_name|default:'' }}" data-tx-account-type="{{ tx.account_type|default:'' }}" data-tx-account="{{ tx.account_id|default:'' }}">è©³ç´°</button>
                                    </div>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %} flag-btn"
                                        data-tx-id="{{ tx.id }}" data-source-tab="large"
                                        title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                        ğŸ“Œ
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">è©²å½“ã™ã‚‹å¤šé¡å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§é–¾å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Tab 3: All Transactions -->
    <div class="tab-pane fade" id="all" role="tabpanel" aria-labelledby="all-tab">
        <div class="glass-card p-4">
            <!-- Filters -->
            <form method="get" class="row g-3 mb-4">
                <div class="col-md-2">
                    <label class="form-label">éŠ€è¡Œå</label>
                    <select name="bank" class="form-select" multiple size="3">
                        {% for bank in banks %}
                        <option value="{{ bank }}" {% if bank in filter_state.bank %}selected{% endif %}>{{ bank }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">å£åº§</label>
                    <select name="account" class="form-select" multiple size="3">
                        {% for acc in accounts %}
                        <option value="{{ acc }}" {% if acc in filter_state.account %}selected{% endif %}>{{ acc }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">åˆ†é¡</label>
                    <select name="category" class="form-select" multiple size="3">
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat in filter_state.category %}selected{% endif %}>{{ cat }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                    <input type="text" name="keyword" class="form-control" value="{{ filter_state.keyword }}"
                        placeholder="æ‘˜è¦ã‚’æ¤œç´¢...">
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-primary flex-grow-1" type="submit">
                        <i class="bi bi-search"></i> æ¤œç´¢
                    </button>
                    <a href="{% url 'analysis-dashboard' case.pk %}?tab=all" class="btn btn-outline-secondary flex-grow-1">
                        <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                    </a>
                </div>
            </form>

            <!-- ä¸€æ‹¬ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form method="post" id="allTxForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="bulk_update_categories">
                <input type="hidden" name="source_tab" value="all">
                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ä¿æŒ -->
                {% for bank in filter_state.bank %}
                <input type="hidden" name="filter_bank" value="{{ bank }}">
                {% endfor %}
                {% for acc in filter_state.account %}
                <input type="hidden" name="filter_account" value="{{ acc }}">
                {% endfor %}
                {% for cat in filter_state.category %}
                <input type="hidden" name="filter_category" value="{{ cat }}">
                {% endfor %}
                {% if filter_state.keyword %}
                <input type="hidden" name="filter_keyword" value="{{ filter_state.keyword }}">
                {% endif %}
                {% if all_txs.number %}
                <input type="hidden" name="filter_page" value="{{ all_txs.number }}">
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">æ¤œç´¢çµæœ: {{ all_txs_count }}ä»¶
                        {% if all_txs.paginator.num_pages > 1 %}
                        <small class="text-muted">({{ all_txs.number }} / {{ all_txs.paginator.num_pages }}ãƒšãƒ¼ã‚¸)</small>
                        {% endif %}
                    </h5>
                    <div>
                        {% if all_txs %}
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="bi bi-check-lg"></i> åˆ†é¡ã‚’ä¸€æ‹¬ä¿å­˜
                        </button>
                        {% endif %}
                        <a href="{% url 'export-csv' case.pk 'all' %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-download"></i> å…¨ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›
                        </a>
                        <a href="{% url 'export-json' case.pk %}" class="btn btn-outline-primary btn-sm" title="JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                            <i class="bi bi-box-arrow-down"></i> JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                        </a>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle table-sm">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œå</th>
                                <th>æ”¯åº—å</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>æ‘˜è¦</th>
                                <th>æ‰•æˆ»</th>
                                <th>ãŠé ã‚Š</th>
                                <th style="min-width: 130px;">åˆ†é¡</th>
                                <th>æ“ä½œ</th>
                                <th>ğŸ“Œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in all_txs %}
                            <tr>
                                <td>{{ tx.date|wareki_short }}</td>
                                <td>{{ tx.bank_name|default:"-" }}</td>
                                <td>{{ tx.branch_name|default:"-" }}</td>
                                <td>{{ tx.account_id|default:"-" }}</td>
                                <td style="max-width: 200px;" class="text-truncate" title="{{ tx.description }}">{{ tx.description }}</td>
                                <td class="text-end">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                                <td class="text-end">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                                <td>
                                    <select name="cat-{{ tx.id }}" class="form-select form-select-sm">
                                        {% for cat in categories %}
                                        <option value="{{ cat }}" {% if tx.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModal" data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}" data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}" data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}" data-tx-cat="{{ tx.category|default:'' }}" data-tx-memo="{{ tx.memo|default:'' }}" data-tx-bank="{{ tx.bank_name|default:'' }}" data-tx-branch="{{ tx.branch_name|default:'' }}" data-tx-account-type="{{ tx.account_type|default:'' }}" data-tx-account="{{ tx.account_id|default:'' }}">è©³ç´°</button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %} flag-btn"
                                        data-tx-id="{{ tx.id }}" data-source-tab="all"
                                        title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                        ğŸ“Œ
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="10" class="text-center">å–å¼•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                {% if all_txs.paginator.num_pages > 1 %}
                <nav aria-label="å–å¼•ä¸€è¦§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" class="mt-3">
                    <ul class="pagination justify-content-center mb-0">
                        {% if all_txs.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page=1{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                &laquo; æœ€åˆ
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page={{ all_txs.previous_page_number }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                å‰ã¸
                            </a>
                        </li>
                        {% endif %}

                        <li class="page-item disabled">
                            <span class="page-link">{{ all_txs.number }} / {{ all_txs.paginator.num_pages }}</span>
                        </li>

                        {% if all_txs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page={{ all_txs.next_page_number }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                æ¬¡ã¸
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page={{ all_txs.paginator.num_pages }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                æœ€å¾Œ &raquo;
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            </form>
        </div>
    </div>

    <!-- Tab 4: Data Cleanup (Duplicates) -->
    <div class="tab-pane fade" id="cleanup" role="tabpanel" aria-labelledby="cleanup-tab">
        <div class="glass-card p-4">
            <h4 class="mb-3 text-warning"><i class="bi bi-exclamation-triangle"></i> é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã¨å‰Šé™¤</h4>
            <p class="text-muted">
                æ—¥ä»˜ã€é‡‘é¡ã€æ‘˜è¦ã€å£åº§IDãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œé‡è¤‡ãƒ‡ãƒ¼ã‚¿ã€ã¨ã—ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br>
                èª¤ã£ã¦äºŒé‡ã«å–ã‚Šè¾¼ã‚“ã§ã—ã¾ã£ãŸå ´åˆãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
            </p>

            <!-- IDç¯„å›²å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card bg-light border-warning mb-4">
                <div class="card-body">
                    <h6 class="card-title text-warning"><i class="bi bi-lightning"></i> IDç¯„å›²æŒ‡å®šã§ä¸€æ‹¬å‰Šé™¤</h6>
                    <p class="small text-muted mb-3">
                        é–‹å§‹IDã‹ã‚‰çµ‚äº†IDã¾ã§ã®å–å¼•ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã€‚ä¸‹ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã§IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <form method="post" class="row g-2 align-items-end">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_by_range">
                        <div class="col-auto">
                            <label for="start_id" class="form-label small">é–‹å§‹ID</label>
                            <input type="number" class="form-control form-control-sm" id="start_id" name="start_id" placeholder="ä¾‹: 100" required style="width: 120px;">
                        </div>
                        <div class="col-auto d-flex align-items-center pt-4">
                            <span class="text-muted">ã€œ</span>
                        </div>
                        <div class="col-auto">
                            <label for="end_id" class="form-label small">çµ‚äº†ID</label>
                            <input type="number" class="form-control form-control-sm" id="end_id" name="end_id" placeholder="ä¾‹: 200" required style="width: 120px;">
                        </div>
                        <div class="col-auto pt-4">
                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('æŒ‡å®šã—ãŸIDç¯„å›²ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')">
                                <i class="bi bi-trash"></i> ç¯„å›²å‰Šé™¤å®Ÿè¡Œ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_duplicates">

                {% if duplicate_txs %}
                <div class="d-flex justify-content-end mb-3">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                        <i class="bi bi-trash"></i> é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                    </button>
                </div>

                <div class="table-responsive" style="max-height: 500px;">
                    <table class="table table-hover align-middle table-sm">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" class="form-check-input"
                                        id="selectAllDup"></th>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œå</th>
                                <th>æ”¯åº—å</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>æ‘˜è¦</th>
                                <th>å‡ºé‡‘</th>
                                <th>å…¥é‡‘</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in duplicate_txs %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="delete_ids" value="{{ tx.id }}"
                                        class="form-check-input dup-check">
                                </td>
                                <td>{{ tx.date|wareki_short }}</td>
                                <td>{{ tx.bank_name|default:"-" }}</td>
                                <td>{{ tx.branch_name|default:"-" }}</td>
                                <td>{{ tx.account_id|default:"-" }}</td>
                                <td>{{ tx.description }}</td>
                                <td class="text-end">{% if tx.amount_out %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                                <td class="text-end">{% if tx.amount_in %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                                <td><small class="text-muted">{{ tx.id }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Tab 5: Flagged (ä»˜ç®‹) -->
    <div class="tab-pane fade" id="flagged" role="tabpanel" aria-labelledby="flagged-tab">
        <div class="glass-card p-4">
            <h4 class="mb-3 text-info"><i class="bi bi-pin-angle"></i> ä»˜ç®‹ä»˜ãå–å¼•</h4>
            <p class="text-muted">
                å¾Œã§ç¢ºèªã—ãŸã„å–å¼•ã«ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å„ã‚¿ãƒ–ã®å–å¼•ä¸€è¦§ã§ğŸ“Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»˜ç®‹ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
            </p>

            {% if flagged_txs %}
            <div class="table-responsive">
                <table class="table table-hover align-middle table-sm">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>éŠ€è¡Œå</th>
                            <th>å£åº§ç•ªå·</th>
                            <th>æ‘˜è¦</th>
                            <th>å‡ºé‡‘</th>
                            <th>å…¥é‡‘</th>
                            <th>åˆ†é¡</th>
                            <th>ãƒ¡ãƒ¢</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in flagged_txs %}
                        <tr>
                            <td>{{ tx.date|wareki_short }}</td>
                            <td>{{ tx.bank_name|default:"-" }}</td>
                            <td>{{ tx.account_id|default:"-" }}</td>
                            <td style="max-width: 200px;" class="text-truncate" title="{{ tx.description }}">{{ tx.description }}</td>
                            <td class="text-end text-danger">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                            <td class="text-end text-success">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                            <td><span class="badge bg-secondary">{{ tx.category|default:"-" }}</span></td>
                            <td style="max-width: 150px;" class="text-truncate" title="{{ tx.memo|default:'' }}">
                                <small class="text-muted">{{ tx.memo|default:"-"|truncatechars:30 }}</small>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button type="button" class="btn btn-sm btn-info flag-btn"
                                        data-tx-id="{{ tx.id }}" data-source-tab="flagged"
                                        title="ä»˜ç®‹ã‚’å¤–ã™">
                                        <i class="bi bi-pin-fill"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" title="è©³ç´°ãƒ»ç·¨é›†"
                                        data-bs-toggle="modal" data-bs-target="#editModal"
                                        data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}"
                                        data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}"
                                        data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}"
                                        data-tx-cat="{{ tx.category|default:'' }}"
                                        data-tx-memo="{{ tx.memo|default:'' }}"
                                        data-tx-bank="{{ tx.bank_name|default:'' }}"
                                        data-tx-branch="{{ tx.branch_name|default:'' }}"
                                        data-tx-account-type="{{ tx.account_type|default:'' }}"
                                        data-tx-account="{{ tx.account_id|default:'' }}">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> ä»˜ç®‹ãŒä»˜ã„ãŸå–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å–å¼•ä¸€è¦§ã§ğŸ“Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»˜ç®‹ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title">å–å¼•ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_transaction">
                <input type="hidden" name="tx_id" id="modalTxId">
                <input type="hidden" name="source_tab" id="modalSourceTab">

                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-3">
                            <label class="form-label">éŠ€è¡Œå</label>
                            <select name="bank_name" class="form-select form-select-sm" id="modalTxBankName">
                                <option value="">-- é¸æŠ --</option>
                                {% for bank in banks %}
                                <option value="{{ bank }}">{{ bank }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-3">
                            <label class="form-label">æ”¯åº—å</label>
                            <select name="branch_name" class="form-select form-select-sm" id="modalTxBranchName">
                                <option value="">-- é¸æŠ --</option>
                                {% for branch in branches %}
                                <option value="{{ branch }}">{{ branch }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-3">
                            <label class="form-label">ç¨®åˆ¥</label>
                            <input type="text" name="account_type" id="modalTxAccountType" class="form-control form-control-sm" placeholder="æ™®é€šé é‡‘ç­‰">
                        </div>
                        <div class="col-3">
                            <label class="form-label">å£åº§ç•ªå·</label>
                            <select name="account_id" class="form-select form-select-sm" id="modalTxAccountId">
                                <option value="">-- é¸æŠ --</option>
                                {% for acc in accounts %}
                                <option value="{{ acc }}">{{ acc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ—¥ä»˜</label>
                        <input type="date" name="date" id="modalTxDate" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ‘˜è¦</label>
                        <input type="text" name="description" id="modalTxDescInput" class="form-control">
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <label class="form-label">æ‰•æˆ»ï¼ˆå‡ºé‡‘ï¼‰</label>
                            <input type="number" name="amount_out" id="modalTxAmountOut" class="form-control">
                        </div>
                        <div class="col-4">
                            <label class="form-label">ãŠé ã‚Šï¼ˆå…¥é‡‘ï¼‰</label>
                            <input type="number" name="amount_in" id="modalTxAmountIn" class="form-control">
                        </div>
                        <div class="col-4">
                            <label class="form-label">æ®‹é«˜</label>
                            <input type="number" name="balance" id="modalTxBalance" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†é¡</label>
                        <select name="category" class="form-select" id="modalTxCat">
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ğŸ“ ãƒ¡ãƒ¢</label>
                        <textarea name="memo" id="modalTxMemo" class="form-control" rows="3"
                            placeholder="ç¢ºèªäº‹é …ãªã©ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã—ã‚‡ã†..."></textarea>
                    </div>

                    <div class="alert alert-warning py-2 small">
                        <i class="bi bi-info-circle"></i> æ—¥ä»˜ã‚„é‡‘é¡ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€æ®‹é«˜ã®æ•´åˆæ€§ãŒå–ã‚Œãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Plotly Chart
    const transferData = JSON.parse('{{ transfer_pairs_json|escapejs }}');
    if (transferData.length > 0) {
        const trace = {
            x: transferData.map(d => d.date),
            y: transferData.map(d => d.amount),
            mode: 'markers',
            type: 'scatter',
            text: transferData.map(d => `${d.label}<br>${d.description}`),
            marker: { size: 12, color: '#2563eb', opacity: 0.7 }
        };

        const layout = {
            title: 'è³‡é‡‘ç§»å‹•ã®æ™‚ç³»åˆ—åˆ†å¸ƒ',
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#334155' },
            xaxis: { title: 'æ—¥ä»˜', gridcolor: '#e2e8f0' },
            yaxis: { title: 'ç§»å‹•é‡‘é¡', gridcolor: '#e2e8f0' }
        };

        Plotly.newPlot('transferChart', [trace], layout);
    }

    // Modal Logic
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;

        const txId = button.getAttribute('data-tx-id');
        const txDate = button.getAttribute('data-tx-date');
        const txDesc = button.getAttribute('data-tx-desc');
        const txAmountOut = button.getAttribute('data-tx-amount-out');
        const txAmountIn = button.getAttribute('data-tx-amount-in');
        const txBalance = button.getAttribute('data-tx-balance');
        const txCat = button.getAttribute('data-tx-cat');
        const txMemo = button.getAttribute('data-tx-memo');
        const txBank = button.getAttribute('data-tx-bank');
        const txBranch = button.getAttribute('data-tx-branch');
        const txAccountType = button.getAttribute('data-tx-account-type');
        const txAccount = button.getAttribute('data-tx-account');

        document.getElementById('modalTxId').value = txId;
        document.getElementById('modalTxDate').value = txDate;
        document.getElementById('modalTxDescInput').value = txDesc;
        document.getElementById('modalTxAmountOut').value = txAmountOut;
        document.getElementById('modalTxAmountIn').value = txAmountIn;
        document.getElementById('modalTxBalance').value = txBalance || '';
        document.getElementById('modalTxCat').value = txCat || 'æœªåˆ†é¡';
        document.getElementById('modalTxMemo').value = txMemo || '';
        document.getElementById('modalTxBankName').value = txBank || '';
        document.getElementById('modalTxBranchName').value = txBranch || '';
        document.getElementById('modalTxAccountType').value = txAccountType || '';
        document.getElementById('modalTxAccountId').value = txAccount || '';

        // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’è¨˜éŒ²
        const activeTab = document.querySelector('#analysisTabs .nav-link.active');
        if (activeTab) {
            const tabId = activeTab.getAttribute('data-bs-target').replace('#', '');
            document.getElementById('modalSourceTab').value = tabId;
        }
    });

    // Select All Duplicates
    const selectAllDup = document.getElementById('selectAllDup');
    if (selectAllDup) {
        selectAllDup.addEventListener('change', function () {
            const checks = document.querySelectorAll('.dup-check');
            checks.forEach(c => c.checked = this.checked);
        });
    }

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¿œã˜ã¦ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
    const urlParams = new URLSearchParams(window.location.search);

    // tabãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
    if (urlParams.has('tab')) {
        const tabId = urlParams.get('tab') + '-tab';
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            const tab = new bootstrap.Tab(targetTab);
            tab.show();
        }
    }
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€Œå–å¼•ä¸€è¦§ã€ã‚¿ãƒ–ã‚’è¡¨ç¤º
    else if (urlParams.has('bank') || urlParams.has('account') || urlParams.has('category') || urlParams.has('keyword')) {
        const allTab = document.getElementById('all-tab');
        if (allTab) {
            const tab = new bootstrap.Tab(allTab);
            tab.show();
        }
    }

    // ä»˜ç®‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãƒã‚¹ãƒˆã‚’å›é¿ã™ã‚‹ãŸã‚ fetch ã§é€ä¿¡ï¼‰
    document.querySelectorAll('.flag-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const txId = this.getAttribute('data-tx-id');
            const sourceTab = this.getAttribute('data-source-tab');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            const formData = new FormData();
            formData.append('action', 'toggle_flag');
            formData.append('tx_id', txId);
            formData.append('source_tab', sourceTab);
            formData.append('csrfmiddlewaretoken', csrfToken);

            fetch(window.location.pathname, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¿ãƒ–ä½ç½®ã‚’ä¿æŒ
                    window.location.href = window.location.pathname + '?tab=' + sourceTab;
                }
            });
        });
    });
</script>

<style>
    .nav-tabs .nav-link {
        color: #64748b;
    }

    .nav-tabs .nav-link.active {
        background-color: #fff;
        border-color: #e2e8f0;
        border-bottom-color: transparent;
        color: #2563eb;
        font-weight: 600;
    }
</style>
{% endblock %}