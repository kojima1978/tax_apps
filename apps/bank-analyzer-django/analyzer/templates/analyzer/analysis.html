{% extends 'analyzer/base.html' %}
{% load humanize %}
{% load japanese_date %}

{% block title %}Analysis - Bank Analyzer{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h2">ğŸ“Š åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰: {{ case.name }}</h1>
    </div>
    <div class="col-md-4 text-end">
        <form method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" name="action" value="apply_rules" class="btn btn-outline-primary me-2"
                onclick="return confirm('è¨­å®šç”»é¢ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ«ãƒ¼ãƒ«ã‚’æœªåˆ†é¡ã®å–å¼•ã«é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ')">
                <i class="bi bi-list-check"></i> ãƒ«ãƒ¼ãƒ«é©ç”¨
            </button>
            <button type="submit" name="action" value="run_classifier" class="btn btn-primary"
                onclick="return confirm('è‡ªå‹•åˆ†é¡ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®æ‰‹å‹•è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚')">
                <i class="bi bi-robot"></i> è‡ªå‹•åˆ†é¡å®Ÿè¡Œ
            </button>
        </form>
    </div>
</div>

<!-- Account Summary -->
<div class="glass-card p-4 mb-4">
    <h4 class="mb-3">ğŸ“‹ ç™»éŒ²å£åº§ä¸€è¦§</h4>
    <div class="row g-3">
        {% for acc in account_summary %}
        <div class="col-md-6 col-lg-4">
            <div class="card bg-white border-light shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-truncate" title="{{ acc.account_id }}">{{ acc.account_id }}</h5>
                    <p class="card-text text-muted mb-2">åç¾©: {{ acc.holder }}</p>
                    <div class="d-flex justify-content-between align-items-end">
                        <small>å–å¼•ä»¶æ•°: {{ acc.count }}ä»¶<br>æœ€çµ‚å–å¼•: {{ acc.last_date|wareki_short }}</small>
                        <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="account_id" value="{{ acc.account_id }}">
                            <button type="submit" name="action" value="delete_account"
                                class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('å£åº§ã€Œ{{ acc.account_id }}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦ã®å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')">
                                <i class="bi bi-trash"></i> å‰Šé™¤
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Tabs -->
<ul class="nav nav-tabs mb-4" id="analysisTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="transfers-tab" data-bs-toggle="tab" data-bs-target="#transfers"
            type="button" role="tab" aria-controls="transfers" aria-selected="true">
            ğŸ”„ è³‡é‡‘ç§»å‹•ãƒ•ãƒ­ãƒ¼
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="large-tab" data-bs-toggle="tab" data-bs-target="#large" type="button" role="tab"
            aria-controls="large" aria-selected="false">
            ğŸ’° å¤šé¡å‡ºé‡‘ãƒ»å…¥é‡‘
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all" type="button" role="tab"
            aria-controls="all" aria-selected="false">
            ğŸ“„ å–å¼•ä¸€è¦§ãƒ»æ¤œç´¢
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link text-warning" id="cleanup-tab" data-bs-toggle="tab" data-bs-target="#cleanup"
            type="button" role="tab" aria-controls="cleanup" aria-selected="false">
            ğŸ§¹ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒ¬ãƒ³ã‚¸ãƒ³ã‚°
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link text-info" id="flagged-tab" data-bs-toggle="tab" data-bs-target="#flagged"
            type="button" role="tab" aria-controls="flagged" aria-selected="false">
            ğŸ“Œ ä»˜ç®‹ {% if flagged_txs %}<span class="badge bg-info">{{ flagged_txs.count }}</span>{% endif %}
        </button>
    </li>
</ul>

<div class="tab-content" id="analysisTabsContent">
    <!-- Tab 1: Transfers -->
    <div class="tab-pane fade show active" id="transfers" role="tabpanel" aria-labelledby="transfers-tab">
        <div class="glass-card p-4">
            <!-- åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <form method="get" class="row g-3 mb-4">
                <input type="hidden" name="tab" value="transfers">
                <div class="col-md-4">
                    <label class="form-label">åˆ†é¡ã§çµã‚Šè¾¼ã¿ <small class="text-muted">(å‡ºé‡‘å…ƒ/ç§»å‹•å…ˆã„ãšã‚Œã‹)</small></label>
                    <select name="transfer_category" class="form-select" multiple size="3">
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat in filter_state.transfer_category %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">çµã‚Šè¾¼ã¿æ–¹æ³•</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="transfer_category_mode" id="transfer_mode_include" value="include" {% if filter_state.transfer_category_mode != 'exclude' %}checked{% endif %}>
                            <label class="form-check-label" for="transfer_mode_include">é¸æŠã‚’å«ã‚€</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="transfer_category_mode" id="transfer_mode_exclude" value="exclude" {% if filter_state.transfer_category_mode == 'exclude' %}checked{% endif %}>
                            <label class="form-check-label" for="transfer_mode_exclude">é¸æŠä»¥å¤–</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i> çµã‚Šè¾¼ã¿
                    </button>
                    <a href="{% url 'analysis-dashboard' case.pk %}?tab=transfers" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                    </a>
                </div>
            </form>

            <form method="post" id="transferForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="bulk_update_transfer_categories">
                <input type="hidden" name="source_tab" value="transfers">

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="mb-0">ğŸ”„ æ¤œå‡ºã•ã‚ŒãŸè³‡é‡‘ç§»å‹•ãƒªã‚¹ãƒˆ {% if filter_state.transfer_category %}<small class="text-muted">(ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­)</small>{% endif %}</h4>
                    <div>
                        {% if transfer_pairs %}
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="bi bi-check-lg"></i> åˆ†é¡ã‚’ä¸€æ‹¬ä¿å­˜
                        </button>
                        <a href="{% url 'export-csv' case.pk 'transfers' %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-download"></i> CSVå‡ºåŠ›
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% if transfer_pairs %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr class="table-secondary">
                                <th colspan="7" class="text-center bg-danger bg-opacity-10">ã€å‡ºé‡‘å…ƒã€‘</th>
                                <th colspan="7" class="text-center bg-success bg-opacity-10">ã€ç§»å‹•å…ˆã€‘</th>
                            </tr>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œ</th>
                                <th>æ”¯åº—</th>
                                <th>å£åº§ç•ªå·</th>
                                <th class="text-end">é‡‘é¡</th>
                                <th>æ‘˜è¦</th>
                                <th style="min-width: 110px;">åˆ†é¡</th>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œ</th>
                                <th>æ”¯åº—</th>
                                <th>å£åº§ç•ªå·</th>
                                <th class="text-end">é‡‘é¡</th>
                                <th>æ‘˜è¦</th>
                                <th style="min-width: 110px;">åˆ†é¡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pair in transfer_pairs %}
                            <tr>
                                <!-- å‡ºé‡‘å…ƒ -->
                                <td>{{ pair.source.date|wareki_short }}</td>
                                <td>{{ pair.source.bank_name|default:"-" }}</td>
                                <td>{{ pair.source.branch_name|default:"-" }}</td>
                                <td>{{ pair.source.account_id|default:"-" }}</td>
                                <td class="text-end text-danger fw-bold">{{ pair.source.amount|intcomma }}</td>
                                <td class="text-truncate" style="max-width: 120px;" title="{{ pair.source.description }}">{{ pair.source.description|default:"-" }}</td>
                                <td>
                                    <select name="transfer-src-{{ pair.source.id }}" class="form-select form-select-sm">
                                        {% for cat in categories %}
                                        <option value="{{ cat }}" {% if pair.source.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <!-- ç§»å‹•å…ˆ -->
                                {% if pair.destination %}
                                <td>{{ pair.destination.date|wareki_short }}</td>
                                <td>{{ pair.destination.bank_name|default:"-" }}</td>
                                <td>{{ pair.destination.branch_name|default:"-" }}</td>
                                <td>{{ pair.destination.account_id|default:"-" }}</td>
                                <td class="text-end text-success fw-bold">{{ pair.destination.amount|intcomma }}</td>
                                <td class="text-truncate" style="max-width: 120px;" title="{{ pair.destination.description }}">{{ pair.destination.description|default:"-" }}</td>
                                <td>
                                    <select name="transfer-dest-{{ pair.destination.id }}" class="form-select form-select-sm">
                                        {% for cat in categories %}
                                        <option value="{{ cat }}" {% if pair.destination.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                {% else %}
                                <td colspan="7" class="text-center text-muted">ï¼ˆå¯¾å¿œã™ã‚‹å…¥é‡‘ãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰</td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="text-muted small mt-2">
                    <i class="bi bi-info-circle"></i> åŒä¸€é‡‘é¡ï¼ˆÂ±1,000å††ï¼‰ã§3æ—¥ä»¥å†…ã«ç•°ãªã‚‹å£åº§é–“ã§ç™ºç”Ÿã—ãŸå‡ºé‡‘ãƒ»å…¥é‡‘ã‚’ãƒšã‚¢ã¨ã—ã¦æ¤œå‡ºã—ã¦ã„ã¾ã™ã€‚å‡ºé‡‘å…ƒã¨ç§»å‹•å…ˆã¯åˆ¥ã€…ã®åˆ†é¡ã‚’è¨­å®šã§ãã¾ã™ã€‚
                </p>
                {% else %}
                <div class="alert alert-info">è³‡é‡‘ç§»å‹•ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Tab 2: Large Transactions -->
    <div class="tab-pane fade" id="large" role="tabpanel" aria-labelledby="large-tab">
        <div class="glass-card p-4">
            <!-- åˆ†é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
            <form method="get" class="row g-3 mb-4">
                <input type="hidden" name="tab" value="large">
                <div class="col-md-4">
                    <label class="form-label">åˆ†é¡ã§çµã‚Šè¾¼ã¿</label>
                    <select name="large_category" class="form-select" multiple size="3">
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat in filter_state.large_category %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">çµã‚Šè¾¼ã¿æ–¹æ³•</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="large_category_mode" id="large_mode_include" value="include" {% if filter_state.large_category_mode != 'exclude' %}checked{% endif %}>
                            <label class="form-check-label" for="large_mode_include">é¸æŠã‚’å«ã‚€</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="large_category_mode" id="large_mode_exclude" value="exclude" {% if filter_state.large_category_mode == 'exclude' %}checked{% endif %}>
                            <label class="form-check-label" for="large_mode_exclude">é¸æŠä»¥å¤–</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-primary" type="submit">
                        <i class="bi bi-search"></i> çµã‚Šè¾¼ã¿
                    </button>
                    <a href="{% url 'analysis-dashboard' case.pk %}?tab=large" class="btn btn-outline-secondary">
                        <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                    </a>
                </div>
            </form>

            <form method="post" id="largeTxForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="bulk_update_categories">
                <input type="hidden" name="source_tab" value="large">

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">å¤šé¡å–å¼•ãƒªã‚¹ãƒˆ {% if filter_state.large_category %}<small class="text-muted">(ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨ä¸­)</small>{% endif %}</h4>
                    <div>
                        {% if large_txs %}
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="bi bi-check-lg"></i> åˆ†é¡ã‚’ä¸€æ‹¬ä¿å­˜
                        </button>
                        <a href="{% url 'export-csv' case.pk 'large' %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-download"></i> CSVå‡ºåŠ›
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% if large_txs %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œå</th>
                                <th>æ”¯åº—å</th>
                                <th>ç¨®åˆ¥</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>æ‘˜è¦</th>
                                <th>æ‰•æˆ»</th>
                                <th>ãŠé ã‚Š</th>
                                <th style="min-width: 130px;">åˆ†é¡</th>
                                <th>æ“ä½œ</th>
                                <th>ğŸ“Œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in large_txs %}
                            <tr>
                                <td>{{ tx.date|wareki_short }}</td>
                                <td>{{ tx.bank_name|default:"-" }}</td>
                                <td>{{ tx.branch_name|default:"-" }}</td>
                                <td>{{ tx.account_type|default:"-" }}</td>
                                <td>{{ tx.account_id|default:"-" }}</td>
                                <td>{{ tx.description }}</td>
                                <td class="text-end text-danger fw-bold">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                                <td class="text-end text-success fw-bold">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                                <td>
                                    <select name="cat-{{ tx.id }}" class="form-select form-select-sm">
                                        {% for cat in categories %}
                                        <option value="{{ cat }}" {% if tx.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModal" data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}" data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}" data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}" data-tx-cat="{{ tx.category|default:'' }}" data-tx-memo="{{ tx.memo|default:'' }}" data-tx-bank="{{ tx.bank_name|default:'' }}" data-tx-branch="{{ tx.branch_name|default:'' }}" data-tx-account-type="{{ tx.account_type|default:'' }}" data-tx-account="{{ tx.account_id|default:'' }}">è©³ç´°</button>
                                    </div>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %} flag-btn"
                                        data-tx-id="{{ tx.id }}" data-source-tab="large"
                                        title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                        ğŸ“Œ
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">è©²å½“ã™ã‚‹å¤šé¡å–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šç”»é¢ã§é–¾å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Tab 3: All Transactions -->
    <div class="tab-pane fade" id="all" role="tabpanel" aria-labelledby="all-tab">
        <div class="glass-card p-4">
            <!-- Filters -->
            <form method="get" class="row g-3 mb-4">
                <div class="col-md-2">
                    <label class="form-label">éŠ€è¡Œå</label>
                    <select name="bank" class="form-select" multiple size="3">
                        {% for bank in banks %}
                        <option value="{{ bank }}" {% if bank in filter_state.bank %}selected{% endif %}>{{ bank }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">å£åº§</label>
                    <select name="account" class="form-select" multiple size="3">
                        {% for acc in accounts %}
                        <option value="{{ acc }}" {% if acc in filter_state.account %}selected{% endif %}>{{ acc }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">åˆ†é¡</label>
                    <select name="category" class="form-select" multiple size="3">
                        {% for cat in categories %}
                        <option value="{{ cat }}" {% if cat in filter_state.category %}selected{% endif %}>{{ cat }}
                        </option>
                        {% endfor %}
                    </select>
                    <div class="d-flex gap-2 mt-1">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="category_mode" id="cat_mode_include" value="include" {% if filter_state.category_mode != 'exclude' %}checked{% endif %}>
                            <label class="form-check-label small" for="cat_mode_include">å«ã‚€</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="category_mode" id="cat_mode_exclude" value="exclude" {% if filter_state.category_mode == 'exclude' %}checked{% endif %}>
                            <label class="form-check-label small" for="cat_mode_exclude">ä»¥å¤–</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢</label>
                    <input type="text" name="keyword" class="form-control" value="{{ filter_state.keyword }}"
                        placeholder="æ‘˜è¦ã‚’æ¤œç´¢...">
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-primary flex-grow-1" type="submit">
                        <i class="bi bi-search"></i> æ¤œç´¢
                    </button>
                    <a href="{% url 'analysis-dashboard' case.pk %}?tab=all" class="btn btn-outline-secondary flex-grow-1">
                        <i class="bi bi-x-lg"></i> ã‚¯ãƒªã‚¢
                    </a>
                </div>
            </form>

            <!-- åˆ†é¡ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
            <form method="post" id="allTxForm">
                {% csrf_token %}
                <input type="hidden" name="action" value="bulk_update_categories">
                <input type="hidden" name="source_tab" value="all">
                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çŠ¶æ…‹ã‚’ä¿æŒ -->
                {% for bank in filter_state.bank %}
                <input type="hidden" name="filter_bank" value="{{ bank }}">
                {% endfor %}
                {% for acc in filter_state.account %}
                <input type="hidden" name="filter_account" value="{{ acc }}">
                {% endfor %}
                {% for cat in filter_state.category %}
                <input type="hidden" name="filter_category" value="{{ cat }}">
                {% endfor %}
                {% if filter_state.keyword %}
                <input type="hidden" name="filter_keyword" value="{{ filter_state.keyword }}">
                {% endif %}
                {% if all_txs.number %}
                <input type="hidden" name="filter_page" value="{{ all_txs.number }}">
                {% endif %}

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">æ¤œç´¢çµæœ: {{ all_txs_count }}ä»¶
                        {% if all_txs.paginator.num_pages > 1 %}
                        <small class="text-muted">({{ all_txs.number }} / {{ all_txs.paginator.num_pages }}ãƒšãƒ¼ã‚¸)</small>
                        {% endif %}
                    </h5>
                    <div>
                        {% if all_txs %}
                        <button type="submit" class="btn btn-primary btn-sm me-2">
                            <i class="bi bi-check-lg"></i> åˆ†é¡ã‚’ä¸€æ‹¬ä¿å­˜
                        </button>
                        {% endif %}
                        <a href="{% url 'export-csv' case.pk 'all' %}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-download"></i> å…¨ãƒ‡ãƒ¼ã‚¿CSVå‡ºåŠ›
                        </a>
                        <a href="{% url 'export-json' case.pk %}" class="btn btn-outline-primary btn-sm" title="JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                            <i class="bi bi-box-arrow-down"></i> JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                        </a>
                    </div>
                </div>

                <!-- é¸æŠä¸€æ‹¬æ“ä½œãƒãƒ¼ -->
                <div class="card bg-light mb-3" id="bulkActionBar" style="display: none;">
                    <div class="card-body py-2">
                        <div class="d-flex align-items-center gap-3">
                            <span id="selectedCountText" class="text-muted">0ä»¶é¸æŠä¸­</span>
                            <select id="bulkCategorySelect" class="form-select form-select-sm" style="width: 150px;">
                                <option value="">-- åˆ†é¡ã‚’é¸æŠ --</option>
                                {% for cat in categories %}
                                <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-success btn-sm" id="applyBulkCategoryBtn">
                                <i class="bi bi-check-lg"></i> é¸æŠã‚’ä¸€æ‹¬å¤‰æ›´
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearSelectionBtn">
                                <i class="bi bi-x-lg"></i> é¸æŠè§£é™¤
                            </button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle table-sm">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="selectAllTx" title="å…¨é¸æŠ">
                                </th>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œå</th>
                                <th>æ”¯åº—å</th>
                                <th>ç¨®åˆ¥</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>æ‘˜è¦</th>
                                <th>æ‰•æˆ»</th>
                                <th>ãŠé ã‚Š</th>
                                <th style="min-width: 130px;">åˆ†é¡</th>
                                <th>æ“ä½œ</th>
                                <th>ğŸ“Œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in all_txs %}
                            <tr>
                                <td>
                                    <input type="checkbox" value="{{ tx.id }}" class="form-check-input tx-select-check">
                                </td>
                                <td>{{ tx.date|wareki_short }}</td>
                                <td>{{ tx.bank_name|default:"-" }}</td>
                                <td>{{ tx.branch_name|default:"-" }}</td>
                                <td>{{ tx.account_type|default:"-" }}</td>
                                <td>{{ tx.account_id|default:"-" }}</td>
                                <td style="max-width: 200px;" class="text-truncate" title="{{ tx.description }}">{{ tx.description }}</td>
                                <td class="text-end">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                                <td class="text-end">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                                <td>
                                    <select name="cat-{{ tx.id }}" class="form-select form-select-sm">
                                        {% for cat in categories %}
                                        <option value="{{ cat }}" {% if tx.category == cat %}selected{% endif %}>{{ cat }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModal" data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}" data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}" data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}" data-tx-cat="{{ tx.category|default:'' }}" data-tx-memo="{{ tx.memo|default:'' }}" data-tx-bank="{{ tx.bank_name|default:'' }}" data-tx-branch="{{ tx.branch_name|default:'' }}" data-tx-account-type="{{ tx.account_type|default:'' }}" data-tx-account="{{ tx.account_id|default:'' }}">è©³ç´°</button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm {% if tx.is_flagged %}btn-info{% else %}btn-outline-secondary{% endif %} flag-btn"
                                        data-tx-id="{{ tx.id }}" data-source-tab="all"
                                        title="{% if tx.is_flagged %}ä»˜ç®‹ã‚’å¤–ã™{% else %}ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹{% endif %}">
                                        ğŸ“Œ
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="12" class="text-center">å–å¼•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>

                <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
                {% if all_txs.paginator.num_pages > 1 %}
                <nav aria-label="å–å¼•ä¸€è¦§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³" class="mt-3">
                    <ul class="pagination justify-content-center mb-0">
                        {% if all_txs.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page=1{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                &laquo; æœ€åˆ
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page={{ all_txs.previous_page_number }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                å‰ã¸
                            </a>
                        </li>
                        {% endif %}

                        <li class="page-item disabled">
                            <span class="page-link">{{ all_txs.number }} / {{ all_txs.paginator.num_pages }}</span>
                        </li>

                        {% if all_txs.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page={{ all_txs.next_page_number }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                æ¬¡ã¸
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?tab=all&page={{ all_txs.paginator.num_pages }}{% for b in filter_state.bank %}&bank={{ b }}{% endfor %}{% for a in filter_state.account %}&account={{ a }}{% endfor %}{% for c in filter_state.category %}&category={{ c }}{% endfor %}{% if filter_state.keyword %}&keyword={{ filter_state.keyword }}{% endif %}">
                                æœ€å¾Œ &raquo;
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            </form>
        </div>
    </div>

    <!-- Tab 4: Data Cleanup (Duplicates) -->
    <div class="tab-pane fade" id="cleanup" role="tabpanel" aria-labelledby="cleanup-tab">
        <div class="glass-card p-4">
            <h4 class="mb-3 text-warning"><i class="bi bi-exclamation-triangle"></i> é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã¨å‰Šé™¤</h4>
            <p class="text-muted">
                æ—¥ä»˜ã€é‡‘é¡ã€æ‘˜è¦ã€å£åº§IDãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œé‡è¤‡ãƒ‡ãƒ¼ã‚¿ã€ã¨ã—ã¦è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚<br>
                èª¤ã£ã¦äºŒé‡ã«å–ã‚Šè¾¼ã‚“ã§ã—ã¾ã£ãŸå ´åˆãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
            </p>

            <!-- IDç¯„å›²å‰Šé™¤ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="card bg-light border-warning mb-4">
                <div class="card-body">
                    <h6 class="card-title text-warning"><i class="bi bi-lightning"></i> IDç¯„å›²æŒ‡å®šã§ä¸€æ‹¬å‰Šé™¤</h6>
                    <p class="small text-muted mb-3">
                        é–‹å§‹IDã‹ã‚‰çµ‚äº†IDã¾ã§ã®å–å¼•ã‚’ä¸€æ‹¬å‰Šé™¤ã—ã¾ã™ã€‚ä¸‹ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ä¸€è¦§ã§IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <form method="post" class="row g-2 align-items-end">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete_by_range">
                        <div class="col-auto">
                            <label for="start_id" class="form-label small">é–‹å§‹ID</label>
                            <input type="number" class="form-control form-control-sm" id="start_id" name="start_id" placeholder="ä¾‹: 100" required style="width: 120px;">
                        </div>
                        <div class="col-auto d-flex align-items-center pt-4">
                            <span class="text-muted">ã€œ</span>
                        </div>
                        <div class="col-auto">
                            <label for="end_id" class="form-label small">çµ‚äº†ID</label>
                            <input type="number" class="form-control form-control-sm" id="end_id" name="end_id" placeholder="ä¾‹: 200" required style="width: 120px;">
                        </div>
                        <div class="col-auto pt-4">
                            <button type="submit" class="btn btn-warning btn-sm" onclick="return confirm('æŒ‡å®šã—ãŸIDç¯„å›²ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')">
                                <i class="bi bi-trash"></i> ç¯„å›²å‰Šé™¤å®Ÿè¡Œ
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete_duplicates">

                {% if duplicate_txs %}
                <div class="d-flex justify-content-end mb-3">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">
                        <i class="bi bi-trash"></i> é¸æŠã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                    </button>
                </div>

                <div class="table-responsive" style="max-height: 500px;">
                    <table class="table table-hover align-middle table-sm">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" class="form-check-input"
                                        id="selectAllDup"></th>
                                <th>æ—¥ä»˜</th>
                                <th>éŠ€è¡Œå</th>
                                <th>æ”¯åº—å</th>
                                <th>ç¨®åˆ¥</th>
                                <th>å£åº§ç•ªå·</th>
                                <th>æ‘˜è¦</th>
                                <th>å‡ºé‡‘</th>
                                <th>å…¥é‡‘</th>
                                <th>ID</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in duplicate_txs %}
                            <tr>
                                <td>
                                    <input type="checkbox" name="delete_ids" value="{{ tx.id }}"
                                        class="form-check-input dup-check">
                                </td>
                                <td>{{ tx.date|wareki_short }}</td>
                                <td>{{ tx.bank_name|default:"-" }}</td>
                                <td>{{ tx.branch_name|default:"-" }}</td>
                                <td>{{ tx.account_type|default:"-" }}</td>
                                <td>{{ tx.account_id|default:"-" }}</td>
                                <td>{{ tx.description }}</td>
                                <td class="text-end">{% if tx.amount_out %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                                <td class="text-end">{% if tx.amount_in %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                                <td><small class="text-muted">{{ tx.id }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- Tab 5: Flagged (ä»˜ç®‹) -->
    <div class="tab-pane fade" id="flagged" role="tabpanel" aria-labelledby="flagged-tab">
        <div class="glass-card p-4">
            <h4 class="mb-3 text-info"><i class="bi bi-pin-angle"></i> ä»˜ç®‹ä»˜ãå–å¼•</h4>
            <p class="text-muted">
                å¾Œã§ç¢ºèªã—ãŸã„å–å¼•ã«ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å„ã‚¿ãƒ–ã®å–å¼•ä¸€è¦§ã§ğŸ“Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»˜ç®‹ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
            </p>

            {% if flagged_txs %}
            <div class="table-responsive">
                <table class="table table-hover align-middle table-sm">
                    <thead>
                        <tr>
                            <th>æ—¥ä»˜</th>
                            <th>éŠ€è¡Œå</th>
                            <th>æ”¯åº—å</th>
                            <th>ç¨®åˆ¥</th>
                            <th>å£åº§ç•ªå·</th>
                            <th>æ‘˜è¦</th>
                            <th>å‡ºé‡‘</th>
                            <th>å…¥é‡‘</th>
                            <th>åˆ†é¡</th>
                            <th>ãƒ¡ãƒ¢</th>
                            <th>è©³ç´°</th>
                            <th>ä»˜ç®‹</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for tx in flagged_txs %}
                        <tr>
                            <td>{{ tx.date|wareki_short }}</td>
                            <td>{{ tx.bank_name|default:"-" }}</td>
                            <td>{{ tx.branch_name|default:"-" }}</td>
                            <td>{{ tx.account_type|default:"-" }}</td>
                            <td>{{ tx.account_id|default:"-" }}</td>
                            <td style="max-width: 200px;" class="text-truncate" title="{{ tx.description }}">{{ tx.description }}</td>
                            <td class="text-end text-danger">{% if tx.amount_out > 0 %}{{ tx.amount_out|intcomma }}{% endif %}</td>
                            <td class="text-end text-success">{% if tx.amount_in > 0 %}{{ tx.amount_in|intcomma }}{% endif %}</td>
                            <td><span class="badge bg-secondary">{{ tx.category|default:"-" }}</span></td>
                            <td style="max-width: 150px;" class="text-truncate" title="{{ tx.memo|default:'' }}">
                                <small class="text-muted">{{ tx.memo|default:"-"|truncatechars:30 }}</small>
                            </td>
                            <td>
                                <div class="d-flex gap-1">
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#editModal" data-tx-id="{{ tx.id }}" data-tx-date="{{ tx.date|date:'Y-m-d' }}" data-tx-desc="{{ tx.description }}" data-tx-amount-out="{{ tx.amount_out }}" data-tx-amount-in="{{ tx.amount_in }}" data-tx-balance="{{ tx.balance|default:'' }}" data-tx-cat="{{ tx.category|default:'' }}" data-tx-memo="{{ tx.memo|default:'' }}" data-tx-bank="{{ tx.bank_name|default:'' }}" data-tx-branch="{{ tx.branch_name|default:'' }}" data-tx-account-type="{{ tx.account_type|default:'' }}" data-tx-account="{{ tx.account_id|default:'' }}">è©³ç´°</button>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-info flag-btn"
                                    data-tx-id="{{ tx.id }}" data-source-tab="flagged"
                                    title="ä»˜ç®‹ã‚’å¤–ã™">
                                    ğŸ“Œ
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> ä»˜ç®‹ãŒä»˜ã„ãŸå–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚å–å¼•ä¸€è¦§ã§ğŸ“Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä»˜ç®‹ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-card">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title">å–å¼•ãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="update_transaction">
                <input type="hidden" name="tx_id" id="modalTxId">
                <input type="hidden" name="source_tab" id="modalSourceTab">

                <div class="modal-body">
                    <div class="row g-2 mb-3">
                        <div class="col-3">
                            <label class="form-label">éŠ€è¡Œå</label>
                            <select name="bank_name" class="form-select form-select-sm" id="modalTxBankName">
                                <option value="">-- é¸æŠ --</option>
                                {% for bank in banks %}
                                <option value="{{ bank }}">{{ bank }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-3">
                            <label class="form-label">æ”¯åº—å</label>
                            <select name="branch_name" class="form-select form-select-sm" id="modalTxBranchName">
                                <option value="">-- é¸æŠ --</option>
                                {% for branch in branches %}
                                <option value="{{ branch }}">{{ branch }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-3">
                            <label class="form-label">ç¨®åˆ¥</label>
                            <input type="text" name="account_type" id="modalTxAccountType" class="form-control form-control-sm" placeholder="æ™®é€šé é‡‘ç­‰">
                        </div>
                        <div class="col-3">
                            <label class="form-label">å£åº§ç•ªå·</label>
                            <select name="account_id" class="form-select form-select-sm" id="modalTxAccountId">
                                <option value="">-- é¸æŠ --</option>
                                {% for acc in accounts %}
                                <option value="{{ acc }}">{{ acc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ—¥ä»˜</label>
                        <input type="date" name="date" id="modalTxDate" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æ‘˜è¦</label>
                        <input type="text" name="description" id="modalTxDescInput" class="form-control">
                    </div>

                    <div class="row g-2 mb-3">
                        <div class="col-4">
                            <label class="form-label">æ‰•æˆ»ï¼ˆå‡ºé‡‘ï¼‰</label>
                            <input type="number" name="amount_out" id="modalTxAmountOut" class="form-control">
                        </div>
                        <div class="col-4">
                            <label class="form-label">ãŠé ã‚Šï¼ˆå…¥é‡‘ï¼‰</label>
                            <input type="number" name="amount_in" id="modalTxAmountIn" class="form-control">
                        </div>
                        <div class="col-4">
                            <label class="form-label">æ®‹é«˜</label>
                            <input type="number" name="balance" id="modalTxBalance" class="form-control">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">åˆ†é¡</label>
                        <select name="category" class="form-select" id="modalTxCat">
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ğŸ“ ãƒ¡ãƒ¢</label>
                        <textarea name="memo" id="modalTxMemo" class="form-control" rows="3"
                            placeholder="ç¢ºèªäº‹é …ãªã©ã‚’ãƒ¡ãƒ¢ã—ã¦ãŠãã¾ã—ã‚‡ã†..."></textarea>
                    </div>

                    <div class="alert alert-warning py-2 small">
                        <i class="bi bi-info-circle"></i> æ—¥ä»˜ã‚„é‡‘é¡ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€æ®‹é«˜ã®æ•´åˆæ€§ãŒå–ã‚Œãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                    </div>
                </div>
                <div class="modal-footer border-top-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Modal Logic
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;

        const txId = button.getAttribute('data-tx-id');
        const txDate = button.getAttribute('data-tx-date');
        const txDesc = button.getAttribute('data-tx-desc');
        const txAmountOut = button.getAttribute('data-tx-amount-out');
        const txAmountIn = button.getAttribute('data-tx-amount-in');
        const txBalance = button.getAttribute('data-tx-balance');
        const txCat = button.getAttribute('data-tx-cat');
        const txMemo = button.getAttribute('data-tx-memo');
        const txBank = button.getAttribute('data-tx-bank');
        const txBranch = button.getAttribute('data-tx-branch');
        const txAccountType = button.getAttribute('data-tx-account-type');
        const txAccount = button.getAttribute('data-tx-account');

        document.getElementById('modalTxId').value = txId;
        document.getElementById('modalTxDate').value = txDate;
        document.getElementById('modalTxDescInput').value = txDesc;
        document.getElementById('modalTxAmountOut').value = txAmountOut;
        document.getElementById('modalTxAmountIn').value = txAmountIn;
        document.getElementById('modalTxBalance').value = txBalance || '';
        document.getElementById('modalTxCat').value = txCat || 'æœªåˆ†é¡';
        document.getElementById('modalTxMemo').value = txMemo || '';
        document.getElementById('modalTxBankName').value = txBank || '';
        document.getElementById('modalTxBranchName').value = txBranch || '';
        document.getElementById('modalTxAccountType').value = txAccountType || '';
        document.getElementById('modalTxAccountId').value = txAccount || '';

        // ç¾åœ¨ã®ã‚¿ãƒ–ã‚’è¨˜éŒ²
        const activeTab = document.querySelector('#analysisTabs .nav-link.active');
        if (activeTab) {
            const tabId = activeTab.getAttribute('data-bs-target').replace('#', '');
            document.getElementById('modalSourceTab').value = tabId;
        }
    });

    // Select All Duplicates
    const selectAllDup = document.getElementById('selectAllDup');
    if (selectAllDup) {
        selectAllDup.addEventListener('change', function () {
            const checks = document.querySelectorAll('.dup-check');
            checks.forEach(c => c.checked = this.checked);
        });
    }

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«å¿œã˜ã¦ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆ
    const urlParams = new URLSearchParams(window.location.search);

    // tabãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯æŒ‡å®šã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
    if (urlParams.has('tab')) {
        const tabId = urlParams.get('tab') + '-tab';
        const targetTab = document.getElementById(tabId);
        if (targetTab) {
            const tab = new bootstrap.Tab(targetTab);
            tab.show();
        }
    }
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€Œå–å¼•ä¸€è¦§ã€ã‚¿ãƒ–ã‚’è¡¨ç¤º
    else if (urlParams.has('bank') || urlParams.has('account') || urlParams.has('category') || urlParams.has('keyword')) {
        const allTab = document.getElementById('all-tab');
        if (allTab) {
            const tab = new bootstrap.Tab(allTab);
            tab.show();
        }
    }

    // ä»˜ç®‹ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆAJAX - ãƒšãƒ¼ã‚¸é·ç§»ãªã—ï¼‰
    document.querySelectorAll('.flag-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const button = this;
            const txId = button.getAttribute('data-tx-id');
            const sourceTab = button.getAttribute('data-source-tab');
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const row = button.closest('tr');

            // ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆäºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢ï¼‰
            button.disabled = true;
            button.style.opacity = '0.5';

            const formData = new FormData();
            formData.append('tx_id', txId);
            formData.append('csrfmiddlewaretoken', csrfToken);

            // APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const apiUrl = window.location.pathname.replace('/analysis/', '/api/toggle-flag/');

            fetch(apiUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ä»˜ç®‹ã‚¿ãƒ–ã§ä»˜ç®‹ã‚’å¤–ã—ãŸå ´åˆã¯è¡Œã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
                    if (sourceTab === 'flagged' && !data.is_flagged) {
                        row.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                        row.style.opacity = '0';
                        row.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            row.remove();
                            // æ®‹ã‚Šä»¶æ•°ã‚’ç¢ºèªã—ã€0ä»¶ãªã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                            const tbody = document.querySelector('#flagged tbody');
                            if (tbody && tbody.querySelectorAll('tr').length === 0) {
                                tbody.innerHTML = `
                                    <tr>
                                        <td colspan="9" class="text-center py-4 text-muted">
                                            ä»˜ç®‹ãŒä»˜ã„ãŸå–å¼•ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
                                        </td>
                                    </tr>
                                `;
                            }
                        }, 300);
                        showToast('ä»˜ç®‹ã‚’å¤–ã—ã¾ã—ãŸ', 'info');
                    } else {
                        // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’æ›´æ–°
                        if (data.is_flagged) {
                            button.classList.remove('btn-outline-secondary');
                            button.classList.add('btn-info');
                            button.title = 'ä»˜ç®‹ã‚’å¤–ã™';
                            showToast('ä»˜ç®‹ã‚’è¿½åŠ ã—ã¾ã—ãŸ', 'success');
                        } else {
                            button.classList.remove('btn-info');
                            button.classList.add('btn-outline-secondary');
                            button.title = 'ä»˜ç®‹ã‚’ä»˜ã‘ã‚‹';
                            showToast('ä»˜ç®‹ã‚’å¤–ã—ã¾ã—ãŸ', 'info');
                        }
                        // ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
                        button.disabled = false;
                        button.style.opacity = '1';
                    }
                } else {
                    showToast('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'danger');
                    button.disabled = false;
                    button.style.opacity = '1';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
                button.disabled = false;
                button.style.opacity = '1';
            });
        });
    });

    // ä»˜ç®‹ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆæœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼‰
    const flaggedTab = document.getElementById('flagged-tab');
    if (flaggedTab) {
        flaggedTab.addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = window.location.pathname + '?tab=flagged';
        });
    }

    // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toastContainer');
        if (!toastContainer) return;

        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-info';
        const icon = type === 'success' ? 'bi-check-circle' : type === 'danger' ? 'bi-exclamation-circle' : 'bi-info-circle';

        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi ${icon} me-2"></i>${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
        toast.show();

        // éè¡¨ç¤ºå¾Œã«è¦ç´ ã‚’å‰Šé™¤
        toastElement.addEventListener('hidden.bs.toast', () => {
            toastElement.remove();
        });
    }

    // ===== ä¸€æ‹¬é¸æŠæ©Ÿèƒ½ =====
    const selectAllTx = document.getElementById('selectAllTx');
    const txCheckboxes = document.querySelectorAll('.tx-select-check');
    const bulkActionBar = document.getElementById('bulkActionBar');
    const selectedCountText = document.getElementById('selectedCountText');
    const clearSelectionBtn = document.getElementById('clearSelectionBtn');
    const applyBulkCategoryBtn = document.getElementById('applyBulkCategoryBtn');
    const bulkCategorySelect = document.getElementById('bulkCategorySelect');

    // é¸æŠçŠ¶æ…‹ã®æ›´æ–°
    function updateSelectionUI() {
        const checkedCount = document.querySelectorAll('.tx-select-check:checked').length;
        if (selectedCountText) {
            selectedCountText.textContent = `${checkedCount}ä»¶é¸æŠä¸­`;
        }
        if (bulkActionBar) {
            bulkActionBar.style.display = checkedCount > 0 ? 'block' : 'none';
        }
        // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’æ›´æ–°
        if (selectAllTx) {
            selectAllTx.checked = checkedCount === txCheckboxes.length && txCheckboxes.length > 0;
            selectAllTx.indeterminate = checkedCount > 0 && checkedCount < txCheckboxes.length;
        }
    }

    // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    if (selectAllTx) {
        selectAllTx.addEventListener('change', function() {
            txCheckboxes.forEach(cb => cb.checked = this.checked);
            updateSelectionUI();
        });
    }

    // å€‹åˆ¥ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
    txCheckboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectionUI);
    });

    // é¸æŠè§£é™¤ãƒœã‚¿ãƒ³
    if (clearSelectionBtn) {
        clearSelectionBtn.addEventListener('click', function() {
            txCheckboxes.forEach(cb => cb.checked = false);
            if (selectAllTx) selectAllTx.checked = false;
            updateSelectionUI();
        });
    }

    // é¸æŠã‚’ä¸€æ‹¬å¤‰æ›´ãƒœã‚¿ãƒ³ï¼ˆé¸æŠã•ã‚ŒãŸè¡Œã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å¤‰æ›´ï¼‰
    if (applyBulkCategoryBtn) {
        applyBulkCategoryBtn.addEventListener('click', function() {
            const selectedCategory = bulkCategorySelect.value;
            if (!selectedCategory) {
                showToast('åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„', 'danger');
                return;
            }

            const checkedBoxes = document.querySelectorAll('.tx-select-check:checked');
            if (checkedBoxes.length === 0) {
                showToast('å–å¼•ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'danger');
                return;
            }

            // é¸æŠã•ã‚ŒãŸè¡Œã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’å¤‰æ›´
            checkedBoxes.forEach(cb => {
                const txId = cb.value;
                const categorySelect = document.querySelector(`select[name="cat-${txId}"]`);
                if (categorySelect) {
                    categorySelect.value = selectedCategory;
                }
            });

            showToast(`${checkedBoxes.length}ä»¶ã®åˆ†é¡ã‚’ã€Œ${selectedCategory}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸï¼ˆä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰`, 'info');
        });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸçŠ¶æ…‹ã‚’ç¢ºèª
    updateSelectionUI();
</script>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;"></div>

<style>
    .nav-tabs .nav-link {
        color: #64748b;
    }

    .nav-tabs .nav-link.active {
        background-color: #fff;
        border-color: #e2e8f0;
        border-bottom-color: transparent;
        color: #2563eb;
        font-weight: 600;
    }
</style>
{% endblock %}