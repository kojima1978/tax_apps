# Bank Analyzer (Django Version)

相続税申告における通帳分析を支援するWebアプリケーションです。
Streamlit版からDjango版へ移行し、UI/UXおよびデータ管理機能を強化しました。

## 特徴

- **モダンで直感的なUI**: Bootstrap 5を採用した、視認性の高いインターフェース
- **案件管理**: 複数の相続案件を個別に管理
- **CSVインポート**: 銀行のCSV/Excelデータを自動エンコーディング検出で取り込み
  - UTF-8, CP932, Shift_JIS 対応
  - 和暦日付（H28.6.3など）の自動変換
  - 残高整合性チェック機能
  - 大量データ対応（50,000フィールドまで）
- **自動分析**:
  - 資金移動の自動検出（出金元・移動先をペアで表示）
  - 多額取引のハイライト（閾値設定可能）
  - ルールベースの自動分類（生活費、贈与、証券会社等）
  - カスタム分類ルール（設定画面でキーワード管理）
- **分類機能**:
  - 取引一覧での直接分類編集
  - 複数選択での一括分類変更
  - 同じ摘要の取引への一括適用
  - 分類フィルターによる絞り込み（含む/以外モード切替）
  - 資金移動の出金元・移動先で別々の分類を設定可能
- **CSVエクスポート**: 分析結果をCSVで出力（Excel対応BOM付きUTF-8）
- **JSONバックアップ**: 案件データの完全バックアップ・リストア
- **重複データ検出**: 誤って二重取り込みしたデータを検出・削除
- **付箋機能**: 確認が必要な取引にマークを付けて管理

## 分類カテゴリー

| カテゴリー | 説明 |
|-----------|------|
| 生活費 | 日常の生活費（スーパー、光熱費、通信費等） |
| 給与 | 給与・賞与・報酬 |
| 贈与 | 100万円以上の振込等 |
| 事業・不動産 | 事業関連・不動産収入 |
| 関連会社 | 関連会社との取引 |
| 銀行 | 定期預金・積立等 |
| 証券・株式 | 証券会社、配当等 |
| 保険会社 | 生命保険・損保等 |
| 通帳間移動 | 口座間の資金移動 |
| その他 | 手数料、利息、ATM等 |
| 未分類 | 未分類の取引 |

## 画面構成

| 画面 | 説明 |
|------|------|
| 案件一覧 | 案件の作成・編集・削除 |
| 案件詳細 | 取引履歴の一覧表示 |
| CSVインポート | ファイルアップロード、プレビュー、残高チェック |
| 分析ダッシュボード | 資金移動、多額取引、取引検索、重複チェック、付箋 |
| 設定 | 閾値、分類キーワードの設定 |

### 分析ダッシュボードのタブ

| タブ | 機能 |
|------|------|
| 資金移動フロー | 口座間の資金移動をペア（出金元・移動先）で表示、出金元・移動先それぞれの分類編集、フィルター（含む/以外） |
| 多額出金・入金 | 閾値以上の取引一覧、分類編集、フィルター（含む/以外） |
| 取引一覧・検索 | 全取引の検索、分類編集、複数選択での一括変更、フィルター（含む/以外） |
| データクレンジング | 重複データの検出・削除、ID範囲指定削除 |
| 付箋 | 確認が必要な取引の管理、詳細モーダルでの編集 |

## 実行方法

### Dockerを使用する場合 (推奨)

プロジェクトルート (`tax_apps/docker`) から:

```bash
docker-compose up -d bank-analyzer
```

ブラウザで http://localhost:8000 にアクセスします。

### ローカル開発

```bash
# 依存ライブラリのインストール
pip install -r requirements.txt

# データベースのセットアップ
python manage.py migrate

# サーバーの起動
python manage.py runserver
```

### Docker単体での実行

```bash
# ビルド
docker build -t bank-analyzer .

# 実行
docker run -p 8000:8000 -v $(pwd)/data:/app/data bank-analyzer
```

## ディレクトリ構造

```
bank-analyzer-django/
├── bank_project/          # Djangoプロジェクト設定
│   ├── settings.py        # 設定ファイル（環境変数対応）
│   ├── urls.py            # ルートURLルーティング
│   └── wsgi.py            # WSGI設定
├── analyzer/              # アプリケーション本体
│   ├── models.py          # データベース定義 (Case, Transaction)
│   ├── views.py           # 画面ロジック
│   ├── services.py        # ビジネスロジック層
│   ├── forms.py           # フォーム定義
│   ├── urls.py            # URLルーティング
│   ├── lib/               # 分析・インポート用ライブラリ
│   │   ├── importer.py    # CSV/Excel読み込み
│   │   ├── analyzer.py    # 多額取引・資金移動分析
│   │   ├── llm_classifier.py  # ルールベース分類
│   │   └── config.py      # 設定管理
│   ├── templates/         # HTMLテンプレート
│   └── templatetags/      # カスタムテンプレートタグ（和暦変換等）
├── data/                  # ユーザー設定保存先
├── Dockerfile             # Docker設定
├── docker-compose.yml     # Docker Compose設定
└── requirements.txt       # Python依存ライブラリ
```

## 環境変数

| 変数名 | 説明 | デフォルト |
|--------|------|------------|
| `DJANGO_DEBUG` | デバッグモード | `True` |
| `DJANGO_SECRET_KEY` | シークレットキー | 開発用キー |
| `DJANGO_ALLOWED_HOSTS` | 許可ホスト（カンマ区切り） | `localhost,127.0.0.1` |

## 技術スタック

- **フレームワーク**: Django 6.x
- **データベース**: SQLite
- **フロントエンド**: Bootstrap 5, Bootstrap Icons
- **データ処理**: pandas
- **Python**: 3.12+

## CSVフォーマット

以下のカラムを含むCSVに対応:

```
銀行名,支店名,口座番号,年月日,摘要,払戻,お預り,差引残高
```

または最小限:

```
年月日,摘要,払戻,お預り,差引残高
```

## 自動分類のカスタマイズ

設定画面でカテゴリーごとのキーワードを編集できます。
摘要にキーワードが含まれる取引が自動的に該当カテゴリーに分類されます。

### 分類の優先順位

1. 給与
2. 生活費
3. 証券・株式
4. 保険会社
5. 銀行
6. 関連会社
7. 通帳間移動
8. 贈与（100万円以上の振込）
9. その他

## ライセンス

Private
