# 相続税通帳分析システム (Inheritance Tax Bank Analyzer) v2.0

## 概要
OCR済み通帳CSVを読み込み、相続税調査で注目すべきポイント（名義預金疑い、多額出金、不自然な資金移動）を自動検知し、可視化するローカル完結型アプリケーションです。

## 特徴
- **完全ローカル動作**: インターネット接続不要、データ外部送信なし（Ollama使用時も完全ローカル）
- **シンプル操作**: CSVインポート → 自動分析 → 結果表示の3ステップ
- **Docker対応**: Dockerで簡単にセットアップ、LLM機能も自動構築
- **自動検知機能**:
  - 口座間資金移動の自動ペアリング（金額・日付近接性で判定）
  - 多額取引フラグ（閾値: カスタマイズ可能）
  - 残高整合性チェック（和暦対応）
  - AI/ルールベースによる取引自動分類
- **データ管理**:
  - 案件・口座単位での削除機能
  - 複数口座データの一元管理
  - 残高不一致の詳細分析

## 動作環境
- Python 3.11+ (Python 3.13推奨)
- 推奨ブラウザ: Chrome, Edge

## セットアップ

### 1. 必要なライブラリをインストール
```bash
cd inheritance-bank-analyzer
pip install -r requirements.txt
```

または

```bash
pip install streamlit pandas polars plotly openpyxl kaleido
```

### 2. アプリケーションを起動
```bash
streamlit run main.py
```

または

```bash
python -m streamlit run main.py
```

アプリケーションが起動したら、ブラウザで http://localhost:8501 にアクセスしてください。

### 3. Dockerで実行する場合（本番環境推奨）

Dockerを使用すると、LLM（Ollama）による取引分類機能も含めて簡単に起動できます。

#### 起動手順

```bash
# コンテナをビルド・起動
docker compose up -d --build

# Ollamaにモデルをダウンロード（初回のみ、数分かかります）
docker compose exec ollama ollama pull gemma2:2b

# 起動確認
docker compose ps
```

起動後、http://localhost:8501 にアクセスしてください。

#### 停止・削除

```bash
# 停止
docker compose stop

# 停止・削除
docker compose down

# データも含めて完全削除（注意: 案件データも削除されます）
docker compose down -v
```

#### GPU利用（オプション）

GPUを使用する場合は、docker-compose.ymlの該当箇所のコメントを外してください。
NVIDIA Container Toolkitのインストールが必要です。

#### トラブルシューティング

- **Ollamaが起動しない**: `docker compose logs ollama` でログを確認
- **アプリが起動しない**: `docker compose logs app` でログを確認
- **ポート競合**: 8501または11434ポートが使用中の場合、docker-compose.ymlでポート番号を変更

## 使い方

### ステップ1: 案件作成
1. サイドバーから「案件一覧」を選択
2. 「新規案件作成」に案件名を入力（例：山田太郎_相続）
3. 「作成」ボタンをクリック
4. 作成された案件を「選択」ボタンで選択

### ステップ2: CSVインポート
1. サイドバーから「CSVインポート」を選択
2. 通帳CSVファイルをアップロード（形式は下記参照）
3. 口座情報を入力:
   - 銀行名（例: 三菱UFJ銀行）
   - 支店名（例: 青山支店）
   - 口座種別（普通/定期/当座）
   - 口座番号
   - 名義人（例: 山田太郎）
4. 「読み込み・検証」ボタンをクリック
5. プレビューを確認後、「このデータを登録して分析を実行する」をクリック

### ステップ3: 取引の自動分類（オプション）
1. サイドバーから「分析・表示」を選択
2. サイドバーの「自動分類」セクションで分類方法を選択:
   - **🤖 AI分類**: Ollama（LLM）を使用した高精度分類（Docker環境推奨）
   - **📝 ルール分類**: キーワードベースの高速分類（常に利用可能）
3. 分類カテゴリ:
   - **生活費**: 日常的な支出（スーパー、コンビニ、光熱費など）
   - **資産形成**: 投資・貯蓄（証券会社、定期預金など）
   - **贈与疑い**: 資金移動が疑われる取引（振込、送金など）
   - **その他**: 上記に該当しない取引

### ステップ4: 分析結果確認
1. 3つのタブで結果を確認:
   - **資金移動フロー**: 口座間の資金移動をサンクダイアグラムで可視化
   - **多額取引**: 100万円以上の取引一覧
   - **全取引一覧**: フィルタ・検索可能な全取引データ（分類フィルタ利用可能）

## CSVフォーマット

以下の形式のCSVファイルに対応しています。

```csv
銀行名,年月日,摘要,払戻,お預り,差引残高
三菱UFJ銀行,2024-01-15,ATM引出,100000,0,900000
三菱UFJ銀行,2024-01-20,給与振込,0,300000,1200000
```

- **年月日**: YYYY-MM-DD形式
- **払戻**: 出金額（円）
- **お預り**: 入金額（円）
- **差引残高**: 残高（円）

## サンプルデータ

`sample_data/` フォルダに動作確認用のサンプルCSVファイルが含まれています。

- `三菱UFJ銀行_sample.csv`
- `みずほ銀行_sample.csv`

詳細は [sample_data/README.md](sample_data/README.md) を参照してください。

## フォルダ構成

```
inheritance-bank-analyzer/
├── main.py                 # アプリケーションのエントリーポイント
├── pages/                  # Streamlitページ
│   ├── 01_案件一覧.py
│   ├── 02_CSVインポート.py
│   └── 03_分析・表示.py
├── lib/                    # ロジック・DB操作
│   ├── config.py           # 設定（閾値等）
│   ├── db_manager.py       # SQLite管理
│   ├── importer.py         # CSV読み込み・検証
│   └── analyzer.py         # 資金移動検知
├── data/                   # 案件データ保存先（自動生成）
│   └── [案件名]/
│       └── transactions.db
├── sample_data/            # サンプルCSVファイル
├── requirements.txt        # 依存ライブラリ
└── README.md
```

## 設定のカスタマイズ

`lib/config.py` で以下の設定を変更できます。

```python
LARGE_AMOUNT_THRESHOLD = 50_000       # 多額取引の閾値（円）
TRANSFER_DAYS_WINDOW = 3                # 資金移動判定の日付誤差（日）
TRANSFER_AMOUNT_TOLERANCE = 1_000       # 資金移動判定の金額誤差（円）
```

## トラブルシューティング

### Streamlitが起動しない
- Pythonのバージョンを確認してください（3.11以上）
- 必要なライブラリが正しくインストールされているか確認してください

### CSVが読み込めない
- CSVファイルのエンコーディングがUTF-8またはShift-JISであることを確認してください
- カラム名が仕様通りであることを確認してください

### 残高不整合エラーが出る
- OCRの読み取りミスの可能性があります
- CSVファイルの数値を確認してください

## 今後の拡張予定

- LLM（Ollama）による摘要文の自動分類
- 複数年度の比較機能
- 手動修正機能
- PDFレポート出力

## ライセンス
Proprietary

---

**開発環境**: Python 3.13 | Streamlit 1.52+ | Polars 1.37+ | Plotly 6.5+
