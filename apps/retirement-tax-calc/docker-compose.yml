# ============================================
# 退職金税額計算シミュレーター - Docker Compose
# ============================================
# Usage:
#   開発:   docker compose up -d
#   再ビルド: docker compose up -d --build
#   ログ:   docker compose logs -f
#   停止:   docker compose down
# ============================================

# 共通設定
x-common-env: &common-env
  TZ: Asia/Tokyo
  NEXT_TELEMETRY_DISABLED: "1"

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 60s

services:
  # ===========================================
  # 退職金税額計算シミュレーター
  # Port: 3013
  #
  # 機能:
  #   - 退職金の税額計算（所得税・復興特別所得税・住民税）
  #   - 最大3パターンの比較シミュレーション
  #   - 役員退職金限度額の計算
  #   - 退職所得控除額・速算表の参照
  #   - 印刷対応
  # ===========================================
  retirement-tax-calc:
    build:
      context: .
      target: dev
    container_name: retirement-tax-calc-standalone
    ports:
      - "3013:3013"
    volumes:
      # ソースコードをマウント（ホットリロード用）
      - ./app:/app/app:ro
      - ./components:/app/components:ro
      - ./hooks:/app/hooks:ro
      - ./lib:/app/lib:ro
    environment:
      <<: *common-env
      NODE_ENV: development
      WATCHPACK_POLLING: "true"
    command: npm run dev -- -p 3013
    init: true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://127.0.0.1:3013/retirement-tax-calc/ || exit 1"]
      <<: *healthcheck-defaults
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M
