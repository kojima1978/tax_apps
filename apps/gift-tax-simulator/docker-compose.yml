# ============================================
# 贈与税計算シミュレーター - Docker Compose
# ============================================
# Usage:
#   開発:   docker compose up -d
#   再ビルド: docker compose up -d --build
#   ログ:   docker compose logs -f
#   停止:   docker compose down
# ============================================

# 共通設定
x-common-env: &common-env
  TZ: Asia/Tokyo

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 5
  start_period: 120s

services:
  # ===========================================
  # 贈与税計算シミュレーター
  # Port: 3001
  #
  # 機能:
  #   - 贈与税シミュレーター（一括/分割比較）
  #   - 贈与税早見表
  #   - 不動産取得税シミュレーター（宅地/その他 分離入力）
  #   - 登録免許税シミュレーター
  #   - 評価額引用（取得税⇔登録免許税間）
  # ===========================================
  gift-tax-simulator:
    build:
      context: .
      dockerfile: ../../docker/Dockerfile.vite-static
      target: dev
      args:
        APP_PORT: "3001"
        APP_PATH: gift-tax-simulator
        APP_TITLE: "Gift Tax Simulator"
        APP_DESCRIPTION: "贈与税シミュレーション（税額計算・早見表・不動産取得税・登録免許税）"
        NPM_CACHE_ID: npm-store-gift-tax-simulator
    container_name: gift-tax-simulator
    networks:
      - tax-apps-network
    ports:
      - "3001:3001"
    volumes:
      - ./src:/app/src:ro
      - ./index.html:/app/index.html:ro
    environment:
      <<: *common-env
      NODE_ENV: development
    command: npm run dev -- --host --port 3001
    init: true
    restart: unless-stopped
    logging: *default-logging
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3001/gift-tax-simulator/ || exit 1"]
      <<: *healthcheck-defaults
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

networks:
  tax-apps-network:
    external: true
