# ============================================
# Nginx Gateway Dockerfile
# Tax Apps Reverse Proxy
# ============================================

FROM nginx:1.27-alpine

# ãƒ©ãƒ™ãƒ«
LABEL org.opencontainers.image.title="Tax Apps Gateway"
LABEL org.opencontainers.image.description="Nginx reverse proxy for Tax Apps"
LABEL org.opencontainers.image.version="1.1.0"

# ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è¨­å®š & å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
RUN apk add --no-cache tzdata \
    && cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime \
    && echo "Asia/Tokyo" > /etc/timezone \
    && apk del tzdata

# ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ»ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p /var/cache/nginx/proxy /var/log/nginx \
    && chown -R nginx:nginx /var/cache/nginx /var/log/nginx

# ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ä½œæˆ
COPY <<'EOF' /usr/share/nginx/html/429.html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>429 Too Many Requests</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 50px; background: #f5f5f5; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #e74c3c; font-size: 24px; margin-bottom: 16px; }
        p { color: #666; line-height: 1.6; }
        .icon { font-size: 48px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">âš ï¸</div>
        <h1>429 Too Many Requests</h1>
        <p>ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤šã™ãã¾ã™ã€‚<br>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
    </div>
</body>
</html>
EOF

COPY <<'EOF' /usr/share/nginx/html/50x.html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Error</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 50px; background: #f5f5f5; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #e74c3c; font-size: 24px; margin-bottom: 16px; }
        p { color: #666; line-height: 1.6; }
        .icon { font-size: 48px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">ğŸ”§</div>
        <h1>ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼</h1>
        <p>ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚µãƒ¼ãƒãƒ¼ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚</p>
    </div>
</body>
</html>
EOF

# 503 ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸
COPY <<'EOF' /usr/share/nginx/html/503.html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Unavailable</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; text-align: center; padding: 50px; background: #f5f5f5; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #f39c12; font-size: 24px; margin-bottom: 16px; }
        p { color: #666; line-height: 1.6; }
        .icon { font-size: 48px; margin-bottom: 16px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">ğŸ”„</div>
        <h1>ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­</h1>
        <p>ç¾åœ¨ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’å®Ÿæ–½ã—ã¦ãŠã‚Šã¾ã™ã€‚<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
    </div>
</body>
</html>
EOF

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY nginx.conf /etc/nginx/nginx.conf
COPY includes /etc/nginx/includes
COPY default.conf /etc/nginx/conf.d/default.conf

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
RUN nginx -t

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost/health || exit 1

EXPOSE 80

# ã‚·ã‚°ãƒŠãƒ«å‡¦ç†ã®ãŸã‚stopsignalè¨­å®š
STOPSIGNAL SIGQUIT

CMD ["nginx", "-g", "daemon off;"]
