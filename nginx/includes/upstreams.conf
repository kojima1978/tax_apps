# ============================================
# アップストリーム定義
# ============================================
#
# keepalive値の基準:
#   32 — ポータル（全リクエストの入口、最も高トラフィック）
#   16 — DB連携アプリ（API+フロントで2 upstream、CRUD操作で接続頻度が高い）
#    8 — 静的寄りのアプリ（計算・表示中心、API呼び出し少）
#
# 新しいアプリを追加する場合:
#   1. このファイルに upstream を追加
#   2. default.conf に location を追加
#   3. maps.conf にフォント対応を追加（Next.jsアプリの場合）
#
# ============================================

# ------------------------------------------
# ポータル (Next.js)
# ------------------------------------------
upstream portal {
    server portal-app:3000;
    keepalive 32;
}

# ------------------------------------------
# 確定申告 必要書類 (Next.js + Express API + SQLite)
# ------------------------------------------
upstream tax-docs-frontend {
    server tax-docs-frontend:3005;
    keepalive 16;
}

upstream tax-docs-backend {
    server tax-docs-backend:3006;
    keepalive 16;
}

# ------------------------------------------
# 相続税案件管理 (Next.js + Hono API + PostgreSQL)
# ------------------------------------------
upstream itcm-frontend {
    server itcm-frontend:3020;
    keepalive 16;
}

upstream itcm-backend {
    server itcm-backend:3021;
    keepalive 16;
}

# ------------------------------------------
# 株式評価システム (Next.js)
# ------------------------------------------
upstream medical-stock-valuation {
    server medical-stock-valuation:3010;
    keepalive 8;
}

upstream shares-valuation {
    server shares-valuation:3012;
    keepalive 8;
}

# ------------------------------------------
# 相続税関連 (Vite / Next.js)
# ------------------------------------------
upstream inheritance-tax-app {
    server inheritance-tax-app:3004;
    keepalive 8;
}

upstream inheritance-tax-docs {
    server inheritance-tax-docs:3003;
    keepalive 8;
}

# ------------------------------------------
# 贈与税関連 (Next.js)
# ------------------------------------------
upstream gift-tax-simulator {
    server gift-tax-simulator:3001;
    keepalive 8;
}

upstream gift-tax-docs {
    server gift-tax-docs:3002;
    keepalive 8;
}

# ------------------------------------------
# 退職金計算 (Next.js)
# ------------------------------------------
upstream retirement-tax-calc {
    server retirement-tax-calc:3013;
    keepalive 8;
}

# ------------------------------------------
# 銀行分析システム (Django + Gunicorn + PostgreSQL)
# ------------------------------------------
# 重い処理（CSV解析、RapidFuzz分類）があるため keepalive を増加
upstream bank-analyzer {
    server bank-analyzer:3007;
    keepalive 16;
}
