# ============================================
# Tax Apps - Production Override
# ============================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================
# Note: restart: unless-stopped is inherited from the base file.
# deploy.restart_policy is Swarm-only and has no effect with docker compose up.
# ============================================

# 本番共通リソース制限 (256M/64M)
x-prod-deploy: &prod-deploy
  resources:
    limits:
      memory: 256M
    reservations:
      memory: 64M

# 本番 gateway リソース制限 (64M/16M)
x-prod-gateway-deploy: &prod-gateway-deploy
  resources:
    limits:
      memory: 64M
    reservations:
      memory: 16M

# 本番 PostgreSQL リソース制限 (512M/128M)
x-prod-postgres-deploy: &prod-postgres-deploy
  resources:
    limits:
      memory: 512M
    reservations:
      memory: 128M

# 本番軽量リソース制限 (128M/32M)
x-prod-small-deploy: &prod-small-deploy
  resources:
    limits:
      memory: 128M
    reservations:
      memory: 32M

# 本番 Node.js サービス共通設定
# runner ステージは ENTRYPOINT に tini を持つため、compose の init は無効化
# Note: ports/volumes の !reset はアンカー(<<:)経由では保持されないため各サービスに明示
x-prod-node-defaults: &prod-node-defaults
  build:
    target: runner
  init: false
  environment:
    NODE_ENV: production
  deploy: *prod-deploy

services:
  # ===========================================
  # Gateway - 本番設定
  # ===========================================
  gateway:
    volumes: !reset []
    ports: !override
      - "80:80"
    deploy: *prod-gateway-deploy

  # ===========================================
  # Portal - 本番設定
  # ===========================================
  portal-app:
    ports: !reset []
    deploy: *prod-gateway-deploy

  # ===========================================
  # 医療法人株式評価 - 本番設定
  # ===========================================
  medical-stock-valuation:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !override
      - ./data/medical-stock:/app/data
    command: []

  # ===========================================
  # 非上場株式評価 - 本番設定
  # ===========================================
  shares-valuation:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []
    command: []

  # ===========================================
  # ITCM PostgreSQL - 本番設定
  # ===========================================
  itcm-postgres:
    ports: !reset []
    deploy: *prod-postgres-deploy

  # ===========================================
  # ITCM Backend - 本番設定
  # ===========================================
  itcm-backend:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []

  # ===========================================
  # ITCM Frontend - 本番設定
  # ===========================================
  itcm-frontend:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []

  # ===========================================
  # Bank Analyzer - 本番設定
  # ===========================================
  bank-analyzer:
    build:
      target: production
    init: false
    ports: !reset []
    volumes: !override
      - ./data/bank-analyzer/data:/app/data
      - ./data/bank-analyzer/db:/app/db
    environment:
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:?DJANGO_SECRET_KEY is required for production}
    command: ["/docker-entrypoint.sh", "gunicorn"]
    deploy: *prod-deploy

  # ===========================================
  # 相続税計算アプリ - 本番設定
  # ===========================================
  inheritance-tax-app:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []
    command: []
    deploy: *prod-small-deploy

  # ===========================================
  # 贈与税シミュレーター（間接税統合）- 本番設定
  # ===========================================
  gift-tax-simulator:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []
    command: []

  # ===========================================
  # 贈与税書類 - 本番設定
  # ===========================================
  gift-tax-docs:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []
    command: []

  # ===========================================
  # 相続税書類 - 本番設定
  # ===========================================
  inheritance-tax-docs:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []
    command: []

  # ===========================================
  # 退職金税額計算 - 本番設定
  # ===========================================
  retirement-tax-calc:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []
    command: []

  # ===========================================
  # 確定申告書類 Backend - 本番設定
  # ===========================================
  tax-docs-backend:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !override
      - ./data/tax-docs:/app/data
    deploy: *prod-small-deploy

  # ===========================================
  # 確定申告書類 Frontend - 本番設定
  # ===========================================
  tax-docs-frontend:
    <<: *prod-node-defaults
    ports: !reset []
    volumes: !reset []
