# ============================================
# Tax Apps - Production Override
# ============================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ============================================

services:
  # ===========================================
  # Gateway - 本番設定
  # ===========================================
  gateway:
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 16M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ===========================================
  # Portal - 本番設定
  # ===========================================
  portal-app:
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  # ===========================================
  # 医療法人株式評価 - 本番設定
  # ===========================================
  medical-stock-valuation:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    command: []
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # 非上場株式評価 - 本番設定
  # ===========================================
  shares-valuation:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    command: []
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # ITCM PostgreSQL - 本番設定
  # ===========================================
  itcm-postgres:
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # ===========================================
  # ITCM Backend - 本番設定
  # ===========================================
  itcm-backend:
    build:
      target: runner
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # ITCM Frontend - 本番設定
  # ===========================================
  itcm-frontend:
    build:
      target: runner
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # Bank Analyzer - 本番設定
  # ===========================================
  bank-analyzer:
    volumes:
      - bank_analyzer_data:/app/data
      - bank_analyzer_db:/app/db
    environment:
      TZ: Asia/Tokyo
      DJANGO_DEBUG: "False"
      DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY:?DJANGO_SECRET_KEY is required for production}
    command: ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "2", "--timeout", "300", "bank_project.wsgi:application"]
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # 相続税計算アプリ - 本番設定
  # ===========================================
  inheritance-tax-app:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    command: []
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

  # ===========================================
  # 贈与税シミュレーター - 本番設定
  # ===========================================
  gift-tax-simulator:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    command: []
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # 贈与税書類 - 本番設定
  # ===========================================
  gift-tax-docs:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    command: []
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # 相続税書類 - 本番設定
  # ===========================================
  inheritance-tax-docs:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    command: []
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # 不動産取得税 - 本番設定
  # ===========================================
  real-estate-tax:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    command: []
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

  # ===========================================
  # 確定申告書類 Backend - 本番設定
  # ===========================================
  tax-docs-backend:
    build:
      target: runner
    volumes:
      - tax_docs_data:/app/data
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 32M

  # ===========================================
  # 確定申告書類 Frontend - 本番設定
  # ===========================================
  tax-docs-frontend:
    build:
      target: runner
    volumes: []
    environment:
      TZ: Asia/Tokyo
      NODE_ENV: production
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M
